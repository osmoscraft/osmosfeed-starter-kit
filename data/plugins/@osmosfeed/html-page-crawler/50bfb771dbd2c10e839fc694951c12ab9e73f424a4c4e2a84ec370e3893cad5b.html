

<!doctype html>
<html lang="en-US">
<head data-template-path="https://hacks.mozilla.org/wp-content/themes/Hax">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="google-site-verification" content="w2ocEMd5yV9IsGCjhq-7ls67r4VH-Ob6oWdiZpqjN8U">

  
  <meta name="title" content="Implementing form filling and accessibility in the Firefox PDF viewer – Mozilla Hacks - the Web developer blog">

    <meta property="og:site_name" content="Mozilla Hacks &#8211; the Web developer blog">
  <meta property="og:url" content="https://hacks.mozilla.org/2021/10/implementing-form-filling-and-accessibility-in-the-firefox-pdf-viewer">
  <meta property="og:title" content="Implementing form filling and accessibility in the Firefox PDF viewer – Mozilla Hacks - the Web developer blog">
  <meta property="og:description" content="We decided it was time to reinvest in the PDF viewer (PDF.js) and support filling PDF forms within Firefox to make our users' lives easier.">
  <meta property="og:image" content="https://hacks.mozilla.org/files/2021/09/1040.png">
  <meta property="og:image:width" content="1023">
  <meta property="og:image:height" content="641">

    <meta property="twitter:title" content="Implementing form filling and accessibility in the Firefox PDF viewer – Mozilla Hacks - the Web developer blog">
  <meta property="twitter:description" content="We decided it was time to reinvest in the PDF viewer (PDF.js) and support filling PDF forms within Firefox to make our users' lives easier.">
    <meta name="twitter:card" content="summary_large_image">
    <meta property="twitter:image" content="https://hacks.mozilla.org/files/2021/09/1040.png">
  <meta name="twitter:site" content="@mozhacks">

  <link href='//fonts.googleapis.com/css?family=Open+Sans:400,400italic,700,700italic' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-content/themes/Hax/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-content/themes/Hax/style.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/highlight.js/8.6.0/styles/solarized_light.min.css">

  <script type="text/javascript">
    window.hacks = {};
    // http://cfsimplicity.com/61/removing-analytics-clutter-from-campaign-urls
    var removeUtms  =   function(){
        var l = window.location;
        if( l.hash.indexOf( "utm" ) != -1 ){
            var anchor = l.hash.match(/#(?!utm)[^&]+/);
            anchor  =   anchor? anchor[0]: '';
            if(!anchor && window.history.replaceState){
                history.replaceState({},'', l.pathname + l.search);
            } else {
                l.hash = anchor;
            }
        };
    };

    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-35433268-8'],
              ['_setAllowAnchor', true]);
    _gaq.push (['_gat._anonymizeIp']);
    _gaq.push(['_trackPageview']);
    _gaq.push( removeUtms );
    (function(d, k) {
      var ga = d.createElement(k); ga.type = 'text/javascript'; ga.async = true;
      ga.src = 'https://ssl.google-analytics.com/ga.js';
      var s = d.getElementsByTagName(k)[0]; s.parentNode.insertBefore(ga, s);
    })(document, 'script');
  </script>

  <meta name='robots' content='index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1' />
<meta name="blog-name" content="Mozilla Hacks - the Web developer blog" />
<link rel="alternate" hreflang="en" href="https://hacks.mozilla.org/2021/10/implementing-form-filling-and-accessibility-in-the-firefox-pdf-viewer/" />
<link rel="alternate" hreflang="x-default" href="https://hacks.mozilla.org/2021/10/implementing-form-filling-and-accessibility-in-the-firefox-pdf-viewer/" />

	<!-- This site is optimized with the Yoast SEO plugin v17.5 - https://yoast.com/wordpress/plugins/seo/ -->
	<title>Implementing form filling and accessibility in the Firefox PDF viewer - Mozilla Hacks - the Web developer blog</title>
	<meta name="description" content="We decided it was time to reinvest in the PDF viewer (PDF.js) and support filling PDF forms within Firefox to make our users&#039; lives easier." />
	<link rel="canonical" href="https://hacks.mozilla.org/2021/10/implementing-form-filling-and-accessibility-in-the-firefox-pdf-viewer/" />
	<meta name="twitter:label1" content="Written by" />
	<meta name="twitter:data1" content="bdahl@mozilla.com" />
	<meta name="twitter:label2" content="Est. reading time" />
	<meta name="twitter:data2" content="14 minutes" />
	<script type="application/ld+json" class="yoast-schema-graph">{"@context":"https://schema.org","@graph":[{"@type":"WebSite","@id":"https://hacks.mozilla.org/#website","url":"https://hacks.mozilla.org/","name":"Mozilla Hacks - the Web developer blog","description":"hacks.mozilla.org","potentialAction":[{"@type":"SearchAction","target":{"@type":"EntryPoint","urlTemplate":"https://hacks.mozilla.org/?s={search_term_string}"},"query-input":"required name=search_term_string"}],"inLanguage":"en-US"},{"@type":"ImageObject","@id":"https://hacks.mozilla.org/2021/10/implementing-form-filling-and-accessibility-in-the-firefox-pdf-viewer/#primaryimage","inLanguage":"en-US","url":"https://hacks.mozilla.org/files/2021/09/1040.png","contentUrl":"https://hacks.mozilla.org/files/2021/09/1040.png","width":1023,"height":641,"caption":"Example PDF.js Form Rendering"},{"@type":"WebPage","@id":"https://hacks.mozilla.org/2021/10/implementing-form-filling-and-accessibility-in-the-firefox-pdf-viewer/#webpage","url":"https://hacks.mozilla.org/2021/10/implementing-form-filling-and-accessibility-in-the-firefox-pdf-viewer/","name":"Implementing form filling and accessibility in the Firefox PDF viewer - Mozilla Hacks - the Web developer blog","isPartOf":{"@id":"https://hacks.mozilla.org/#website"},"primaryImageOfPage":{"@id":"https://hacks.mozilla.org/2021/10/implementing-form-filling-and-accessibility-in-the-firefox-pdf-viewer/#primaryimage"},"datePublished":"2021-10-07T15:13:02+00:00","dateModified":"2021-10-14T15:56:43+00:00","author":{"@id":"https://hacks.mozilla.org/#/schema/person/72406da07a0a1a4a0f5c45d921ac0999"},"description":"We decided it was time to reinvest in the PDF viewer (PDF.js) and support filling PDF forms within Firefox to make our users' lives easier.","breadcrumb":{"@id":"https://hacks.mozilla.org/2021/10/implementing-form-filling-and-accessibility-in-the-firefox-pdf-viewer/#breadcrumb"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://hacks.mozilla.org/2021/10/implementing-form-filling-and-accessibility-in-the-firefox-pdf-viewer/"]}]},{"@type":"BreadcrumbList","@id":"https://hacks.mozilla.org/2021/10/implementing-form-filling-and-accessibility-in-the-firefox-pdf-viewer/#breadcrumb","itemListElement":[{"@type":"ListItem","position":1,"name":"Home","item":"https://hacks.mozilla.org/"},{"@type":"ListItem","position":2,"name":"Articles","item":"https://hacks.mozilla.org/articles/"},{"@type":"ListItem","position":3,"name":"Implementing form filling and accessibility in the Firefox PDF viewer"}]},{"@type":"Person","@id":"https://hacks.mozilla.org/#/schema/person/72406da07a0a1a4a0f5c45d921ac0999","name":"bdahl@mozilla.com","image":{"@type":"ImageObject","@id":"https://hacks.mozilla.org/#personlogo","inLanguage":"en-US","url":"https://secure.gravatar.com/avatar/79f0e968c1f3c1077aaba34bb5ede0a1?s=96&d=mm&r=g","contentUrl":"https://secure.gravatar.com/avatar/79f0e968c1f3c1077aaba34bb5ede0a1?s=96&d=mm&r=g","caption":"bdahl@mozilla.com"},"sameAs":["https://adriftwith.me"],"url":"https://hacks.mozilla.org/author/bdahlmozilla-com/"}]}</script>
	<!-- / Yoast SEO plugin. -->


<link rel='dns-prefetch' href='//blog.mozilla.org' />
<link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="Mozilla Hacks - the Web developer blog &raquo; Feed" href="https://hacks.mozilla.org/feed/" />
<link rel="alternate" type="application/rss+xml" title="Mozilla Hacks - the Web developer blog &raquo; Comments Feed" href="https://hacks.mozilla.org/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="Mozilla Hacks - the Web developer blog &raquo; Implementing form filling and accessibility in the Firefox PDF viewer Comments Feed" href="https://hacks.mozilla.org/2021/10/implementing-form-filling-and-accessibility-in-the-firefox-pdf-viewer/feed/" />
<link rel='stylesheet' id='wp-block-library-css'  href='https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-includes/css/dist/block-library/style.min.css?ver=5.8.2' type='text/css' media='all' />
<link rel='stylesheet' id='mediaelement-css'  href='https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-includes/js/mediaelement/mediaelementplayer-legacy.min.css?ver=4.2.16' type='text/css' media='all' />
<link rel='stylesheet' id='wp-mediaelement-css'  href='https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-includes/js/mediaelement/wp-mediaelement.min.css?ver=5.8.2' type='text/css' media='all' />
<link rel='stylesheet' id='wpml-legacy-post-translations-0-css'  href='//blog.mozilla.org/hacks/wp-content/plugins/sitepress-multilingual-cms/templates/language-switchers/legacy-post-translations/style.min.css?ver=1' type='text/css' media='all' />
<script type='text/javascript' src='https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-includes/js/jquery/jquery.min.js?ver=3.6.0' id='jquery-core-js'></script>
<script type='text/javascript' src='https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-includes/js/jquery/jquery-migrate.min.js?ver=3.3.2' id='jquery-migrate-js'></script>
<script type='text/javascript' src='https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-content/themes/Hax/js/analytics.js?ver=5.8.2' id='analytics-js'></script>
<link rel="https://api.w.org/" href="https://hacks.mozilla.org/wp-json/" /><link rel="alternate" type="application/json" href="https://hacks.mozilla.org/wp-json/wp/v2/posts/47372" /><link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://hacks.mozilla.org/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://hacks.mozilla.org/wp-includes/wlwmanifest.xml" /> 
<link rel='shortlink' href='https://hacks.mozilla.org/?p=47372' />
<link rel="alternate" type="application/json+oembed" href="https://hacks.mozilla.org/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fhacks.mozilla.org%2F2021%2F10%2Fimplementing-form-filling-and-accessibility-in-the-firefox-pdf-viewer%2F" />
<link rel="alternate" type="text/xml+oembed" href="https://hacks.mozilla.org/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fhacks.mozilla.org%2F2021%2F10%2Fimplementing-form-filling-and-accessibility-in-the-firefox-pdf-viewer%2F&#038;format=xml" />
<meta name="generator" content="WPML ver:4.5.1 stt:59,61,1,2;" />
<link rel="shortcut icon" type="image/x-icon" href="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-content/themes/Hax/favicon.ico" /><style>#wpadminbar #wp-admin-bar-site-name>.ab-item:before { content: none !important;}li#wp-admin-bar-site-name a { background: url( "https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-content/themes/Hax/favicon.ico" ) left center/20px no-repeat !important; padding-left: 21px !important; background-size: 20px !important; } li#wp-admin-bar-site-name { margin-left: 5px !important; } li#wp-admin-bar-site-name {} #wp-admin-bar-site-name div a { background: none !important; }
</style></head>
<body>
  <div class="outer-wrapper">
    <header class="section section--fullwidth header">
      <div class="masthead row">
        <div class="branding block block--3">
          <h1>
            <a href="https://hacks.mozilla.org">
              <img class="branding__logo" src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-content/themes/Hax/img/mdn-logo-mono.svg">
              <img class="branding__wordmark" src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-content/themes/Hax/img/wordmark.svg" alt="Mozilla">
              <span class="branding__title">Hac<span class="logo-askew">k</span>s</span>
            </a>
          </h1>
        </div>
        <div class="search block block--2">
          <form class="search__form" method="get" action="https://hacks.mozilla.org/">
            <input type="search" name="s" class="search__input" placeholder="Search Mozilla Hacks" value="">
            <i class="fa fa-search search__badge"></i>
          </form>
        </div>
        <nav class="social">
          <a class="social__link youtube" href="http://www.youtube.com/user/mozhacks" title="YouTube"><i class="fa fa-youtube" aria-hidden="true"></i><span>Hacks on YouTube</span></a>
          <a class="social__link twitter" href="https://twitter.com/mozhacks" title="Twitter"><i class="fa fa-twitter" aria-hidden="true"></i><span>@mozhacks on Twitter</span></a>
          <a class="social__link rss" href="https://hacks.mozilla.org/feed/" title="RSS Feed"><i class="fa fa-rss" aria-hidden="true"></i><span>Hacks RSS Feed</span></a>
          <a class="fx-button" href="https://www.mozilla.org/firefox/download/thanks/?utm_source=hacks.mozilla.org&utm_medium=referral&utm_campaign=header-download-button&utm_content=header-download-button">Download Firefox</a>
        </nav>
      </div>
    </header>

  
<div id="content-head" class="section">
  <h1 class="post__title">Implementing form filling and accessibility in the Firefox PDF viewer</h1>
  <div class="byline">
    <h3 class="post__author">
                      <img alt='' src='https://secure.gravatar.com/avatar/79f0e968c1f3c1077aaba34bb5ede0a1?s=64&#038;d=mm&#038;r=g' srcset='https://secure.gravatar.com/avatar/79f0e968c1f3c1077aaba34bb5ede0a1?s=128&#038;d=mm&#038;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' loading='lazy'/>        By
                                        <a class="url" href="https://adriftwith.me" rel="external me">bdahl</a>,                                                  <a class="url" href="https://hacks.mozilla.org/author/cdenizetmozilla-com/">Calixte Denizet</a>,                                                  <a class="url" href="https://marco-c.github.io/" rel="external me">Marco Castelluccio</a>                            </h2>
    <div class="post__meta">
      Posted on
      <abbr class="published" title="2021-10-07T08:13:02-07:00">
        October 7, 2021      </abbr>
      <span class="entry-cat">in
        <a href="https://hacks.mozilla.org/category/featured/" rel="category tag" title="View all posts in Featured Article" >Featured Article</a> and <a href="https://hacks.mozilla.org/category/firefox/" rel="category tag" title="View all posts in Firefox" >Firefox</a>      </span>
            <div class="socialshare" data-type="bubbles"></div>
    </div>
  </div>
</div>

<main id="content-main" class="section article">
  <article class="post" role="article">
    <h2 class="c1"><span class="c8">Intro</span></h2>
<p class="c1"><span class="c0">Last year, during lockdown, many discovered the importance of PDF forms when having to deal remotely with administrations and large organizations like banks. Firefox supported displaying PDF forms, but it didn’t support filling them: users had to print them, fill them by hand, and scan them back to digital form. </span><span class="c0">We decided it was time to reinvest in the PDF viewer (PDF.js) and support filling PDF forms within Firefox to make our users&#8217; lives easier.</span></p>
<p class="c1"><span class="c0">While we invested more time in the PDF viewer, we also went through the backlog of work and prioritized improving the accessibility of </span><span class="c0">our PDF reader for users of assistive technologies. Below we&#8217;ll describe how we implemented the form support, improved accessibility, and made sure we had no regressions along the way.<br />
</span></p>
<h2 class="c1"><span class="c8">Brief Summary of the PDF.js Architecture</span></h2>
<p class="c1"><span class="c0"><a href="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2021/09/pdfjs_architecture.png"><img loading="lazy" class="alignnone wp-image-47373 size-large" src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2021/09/pdfjs_architecture-500x245.png" alt="Overview of the PDF.js Architecture" width="500" height="245" srcset="https://hacks.mozilla.org/files/2021/09/pdfjs_architecture-500x245.png 500w, https://hacks.mozilla.org/files/2021/09/pdfjs_architecture-250x122.png 250w, https://hacks.mozilla.org/files/2021/09/pdfjs_architecture-768x376.png 768w, https://hacks.mozilla.org/files/2021/09/pdfjs_architecture-1536x752.png 1536w, https://hacks.mozilla.org/files/2021/09/pdfjs_architecture.png 1999w" sizes="(max-width: 500px) 100vw, 500px" /></a>To understand how we added support for forms and tagged PDFs, it’s first important to understand some basics about how the PDF viewer (PDF.js) works in Firefox.</span></p>
<p class="c1"><span class="c0">First, PDF.js will fetch and parse the document in a web worker. The parsed document will then generate drawing instructions. PDF.js sends them to the main thread and draws them on an HTML5 canvas element.<br />
</span></p>
<p class="c1">Besides the canvas, PDF.js potentially creates three more layers that are displayed on top of it. The first layer, the <em><strong>text layer</strong>,</em> enables text selection and search<span class="c0">. It contains span elements that are transparent and line up with the text drawn below them on the canvas. The other two layers are the <strong><em>Annotation/AcroForm layer</em></strong> and the <strong><em>XFA form layer</em></strong>. They support form filling and we will describe them in more detail below.</span></p>
<h2 class="c1"><span class="c8">Filling Forms (AcroForms)</span></h2>
<p class="c1"><span class="c0">AcroForms are one of two types of forms that PDF supports, the most common type of form.</span></p>
<h3>AcroForm structure</h3>
<p class="c1"><span class="c0">Within a PDF file, the form elements are stored in the annotation data. Annotations in PDF are separate elements from the main content of a document. They are often used for things like taking notes on a document or drawing on top of a document. AcroForm annotation elements support user input similar to HTML input e.g. text, check boxes, radio buttons.</span></p>
<h3>AcroForm implementation</h3>
<p class="c1"><span class="c0">In PDF.js, we parse a PDF file and create the annotations in a web worker. Then, we send them out from the worker and render them in the main process using HTML elements inserted in a div (annotation layer). We render this annotation layer, composed of HTML elements, on top of the canvas layer.</span></p>
<p class="c1"><span class="c0">The annotation layer works well for displaying the form elements in the browser, but it was not compatible with the way PDF.js supports printing. When printing a PDF, we draw its contents on a special printing canvas, insert it into the current document and send it to the printer. To support printing form elements with user input, we needed to draw them on the canvas.</span></p>
<p class="c1">By inspecting (with the help of the <span class="c4"><a class="c6" href="https://github.com/qpdf/qpdf">qpdf</a></span> tool) the raw PDF data of forms saved using other tools, we discovered that we needed to save the appearance of a filled field by using some PDF <span class="c0">drawing instructions, and that we could support both saving and printing with a common implementation.</span></p>
<p class="c1">To generate the field appearance, we needed to get the values entered by the user. We introduced an object called annotationStorage to store those values by using callback functions in the corresponding HTML elements. The annotationStorage is then passed to the worker when saving or printing<span class="c0">, and the values for each annotation are used to create an appearance.</span></p>
<p class="c1"><img loading="lazy" class="alignnone size-large wp-image-47377" src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2021/09/1040-500x313.png" alt="Example PDF.js Form Rendering" width="500" height="313" srcset="https://hacks.mozilla.org/files/2021/09/1040-500x313.png 500w, https://hacks.mozilla.org/files/2021/09/1040-250x157.png 250w, https://hacks.mozilla.org/files/2021/09/1040-768x481.png 768w, https://hacks.mozilla.org/files/2021/09/1040.png 1023w" sizes="(max-width: 500px) 100vw, 500px" /></p>
<p class="c1"><span class="c0">On top a filled form in Firefox and on bottom the printed PDF opened in Evince.</span></p>
<h2 class="c1"><span class="c8">Safely Executing JavaScript within PDFs<br />
</span></h2>
<p class="c1">Thanks to our Telemetry, we discovered that many forms contain and use embedded JavaScript code (yes, that&#8217;s a thing!).</p>
<p class="c1">JavaScript in PDFs can be used for many things, but is most commonly used to validate data entered by the user or automatically calculate formulas. For example, in <span class="c4"><a class="c6" href="https://impotsdirects.public.lu/dam-assets/fr/formulaires/fiches_d_impot/2020/160F-2020.pdf">this PDF</a></span><span class="c0">, tax calculations are performed automatically starting from user input. Since this feature is common and helpful to users, we set out to implement it in PDF.js.</span></p>
<h3>The alternatives</h3>
<p class="c1"><span class="c0">From the start of our JavaScript implementation, our main concern was security. We did not want PDF files to become a new vector for attacks. Embedded JS code must be executed when a PDF is loaded or on events generated by form elements (focus, input, …).</span></p>
<p class="c1">We investigated using the following<span class="c8">:</span></p>
<ol class="c5 lst-kix_n33gp6i2lgcq-0 start" start="1">
<li class="c1 c7 li-bullet-0">JS <span class="c9">eval </span><span class="c0">function</span></li>
<li class="c1 c7 li-bullet-0">JS engine compiled in <span class="c4"><a class="c6" href="https://developer.mozilla.org/en-US/docs/WebAssembly">WebAssembly</a></span> with <span class="c4"><a class="c6" href="https://github.com/emscripten-core/emscripten">emscripten</a></span></li>
<li class="c1 c7 li-bullet-0">Firefox JS engine <span class="c4"><a class="c6" href="https://web.archive.org/web/20210506210158/https://developer.mozilla.org/en-US/docs/Mozilla/Tech/XPCOM/Language_Bindings/Components.utils.Sandbox">ComponentUtils.Sandbox</a></span></li>
</ol>
<p class="c1">The first option, while simple, was immediately discarded since running untrusted code in <span class="c9">eval</span> is very unsafe.</p>
<p class="c1">Option two, using a JS engine compiled with WebAssembly, was a strong contender since it would work with the built-in Firefox PDF viewer and the version of PDF.js that can be used in regular websites. However, it would have been a large new attack surface to audit. It would have also considerably increased the size of PDF.js and it would have been slower.</p>
<p class="c1">The third option, sandboxes, is a feature exposed to privileged code in Firefox that allows <em><strong>JS execution in a special isolated environment</strong></em>. The sandbox is created with a <span class="c4"><a class="c6" href="https://web.archive.org/web/20210531054716/https://developer.mozilla.org/en-US/docs/Mozilla/Gecko/Script_security">null principal</a></span><span class="c0">, which means that everything within the sandbox can only be accessed by it and can only access other things within the sandbox itself (and by privileged Firefox code).</span></p>
<h3>Our final choice</h3>
<p class="c1">We settled on using a ComponentUtils.Sandbox for the Firefox built-in viewer. ComponentUtils.Sandbox has been used for years now in WebExtensions, so this implementation is battle tested and very safe: executing a script from a PDF is at least as safe as executing one from a normal web page.</p>
<p class="c1">For the generic web viewer (where we can only use standard web APIs, so we know nothing about ComponentUtils.Sandbox) and the <span class="c4"><a class="c6" href="https://github.com/mozilla/pdf.js">pdf.js</a></span> test suite we used a WebAssembly version of <span class="c4"><a class="c6" href="https://github.com/bellard/quickjs">QuickJS</a></span> (see <span class="c4"><a class="c6" href="https://github.com/mozilla/pdf.js.quickjs">pdf.js.quickjs</a></span> for details)<span class="c0">.</span></p>
<p class="c1">The <span class="c4"><a class="c6" href="https://searchfox.org/mozilla-central/source/toolkit/components/pdfjs/content/PdfSandbox.jsm">implementation</a></span><span class="c0"> of the PDF sandbox in Firefox works as follows:</span></p>
<ul class="c5 lst-kix_663mt1xlbe3z-0 start">
<li class="c1 c7 li-bullet-0"><span class="c0">We collect all the fields and their properties (including the JS actions associated with them) and then clone them into the sandbox;</span></li>
<li class="c1 c7 li-bullet-0">At build time, we generate a bundle with the <span class="c4"><a class="c6" href="https://github.com/mozilla/pdf.js/tree/master/src/scripting_api">JS code</a></span><span class="c0"> to implement the PDF JS API (totally different from the web API we are accustomed to!). We load it in the sandbox and then execute it with the data collected during the first step;</span></li>
<li class="c1 c7 li-bullet-0">In the<span class="c0"> HTML representation of the fields we added callbacks to handle the events (focus, input, …). The callbacks simply dispatch them into the sandbox through an object containing the field identifier and linked parameters. We execute the corresponding JS actions in the sandbox using eval (it’s safe in this case: we’re in a sandbox). Then, we clone the result and dispatch it outside the sandbox to update the states in the HTML representations of the fields.</span></li>
</ul>
<p class="c1"><span class="c0">We decided not to implement the PDF APIs related to I/O (network, disk, …) to avoid any security concerns.</span></p>
<h2 class="c1"><span class="c9">Yet Another Form Format: XFA</span></h2>
<p class="c1">Our Telemetry also informed us that another type of PDF forms, <span class="c4"><a class="c6" href="https://en.wikipedia.org/wiki/XFA">XFA</a></span><span class="c0">, was fairly common. This format has been removed from the official PDF specification, but many PDFs with XFA still exist and are viewed by our users so we decided to implement it as well.</span></p>
<h3>The XFA format</h3>
<p class="c1"><span class="c0">The XFA format is very different from what is usually in PDF files. A normal PDF is typically a list of drawing commands with all layout statically defined by the PDF generator. However, XFA is much closer to HTML and has a more dynamic layout that the PDF viewer must generate. In reality XFA is a totally different format that was bolted on to PDF.</span></p>
<p class="c1">The XFA entry in a PDF contains multiple <span class="c4"><a class="c6" href="https://en.wikipedia.org/wiki/XML">XML</a></span> streams: the most important being the template and datasets. The <span class="c9">template</span> XML contains all the information required to render the form: it contains the UI elements (e.g. text fields, checkboxes, …) and containers (subform, draw, …) which can have static or dynamic layouts. The <span class="c9">datasets</span><span class="c0"> XML contains all the data used by the form itself (e.g. text field content, checkbox state, …). All these data are bound into the template (before layout) to set the values of the different UI elements.<br />
</span></p>
<h4>Example Template</h4>
<pre class="xml"><code>&lt;template xmlns="http://www.xfa.org/schema/xfa-template/3.6/"&gt;
  &lt;subform&gt;
    &lt;pageSet name="ps"&gt;
      &lt;pageArea name="page1" id="Page1"&gt;
        &lt;contentArea x="7.62mm" y="30.48mm" w="200.66mm" h="226.06mm"/&gt;
        &lt;medium stock="default" short="215.9mm" long="279.4mm"/&gt;
      &lt;/pageArea&gt;
    &lt;/pageSet&gt;
    &lt;subform&gt;
      &lt;draw name="Text1" y="10mm" x="50mm" w="200mm" h="7mm"&gt;
        &lt;font size="15pt" typeface="Helvetica"/&gt;
        &lt;value&gt;
          &lt;text&gt;Hello XFA &amp; PDF.js world !&lt;/text&gt;
        &lt;/value&gt;
      &lt;/ draw&gt;
    &lt;/subform&gt;
  &lt;/subform&gt;
&lt;/template&gt;</code></pre>
<h4>Output From Template</h4>
<p><img loading="lazy" class="alignnone size-large wp-image-47392" src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2021/09/xfa_rendering-500x195.png" alt="Rendering of XFA Document" width="500" height="195" srcset="https://hacks.mozilla.org/files/2021/09/xfa_rendering-500x195.png 500w, https://hacks.mozilla.org/files/2021/09/xfa_rendering-250x97.png 250w, https://hacks.mozilla.org/files/2021/09/xfa_rendering-768x299.png 768w, https://hacks.mozilla.org/files/2021/09/xfa_rendering.png 1172w" sizes="(max-width: 500px) 100vw, 500px" /></p>
<h3>The XFA implementation</h3>
<p class="c1">In PDF.js we already had a pretty good XML parser to retrieve metadata about PDFs: it was a good start.</p>
<p class="c1">We decided to map every XML node to a JavaScript object, whose structure is used to validate the node (e.g. possible children and their different numbers). Once the XML is parsed and validated, the form data needs to be bound in the form template and some prototypes can be used with the help of <span class="c4"><a class="c6" href="https://www.w3.org/1999/05/XFA/xfa-template.html#prose-som">SOM</a></span> expressions (kind of <span class="c4"><a class="c6" href="https://en.wikipedia.org/wiki/XPath">XPath</a></span><span class="c0"> expressions).</span></p>
<h4>The layout engine</h4>
<p class="c1">In XFA, we can have different kinds of layouts and the final layout depends on the contents. We initially planned to piggyback on the Firefox layout engine, but we discovered that unfortunately we would need to lay everything out ourselves because XFA uses some layout features which don’t exist in Firefox<span class="c0">. For example, when a container is overflowing the extra contents can be put in another container (often on a new page, but sometimes also in another subform).  Moreover, some template elements don’t have any dimensions, which must be inferred based on their contents.</span></p>
<p class="c1"><span class="c0">In the end <em>we implemented a custom layout engine</em>: we traverse the template tree from top to bottom and, following layout rules, check if an element fits into the available space. If it doesn’t, we flush all the elements layed out so far into the current content area, and we move to the next one.</span></p>
<p>During layout, we convert all the XML elements into JavaScript objects with a tree structure. Then, we send them to the main process to be converted into HTML elements and placed in the XFA layer.</p>
<h4>The missing font problem</h4>
<p class="c1">As mentioned above, the dimensions of some elements are not specified. We must compute them ourselves based on the font used in them. This is even more challenging because sometimes fonts are not embedded in the PDF file.</p>
<p class="c1">Not embedding fonts in a PDF is considered bad practice, but in reality many PDFs do not include some well-known fonts (e.g. the ones shipped by Acrobat or Windows: Arial, Calibri, &#8230;) as PDF creators simply expected them to be always available.</p>
<p class="c1">To have our output more closely match Adobe Acrobat, we decided to ship the <span class="c4"><a class="c6" href="https://en.wikipedia.org/wiki/Liberation_fonts">Liberation</a></span><span class="c0"> fonts and glyph widths of well-known fonts. We used the widths to rescale the glyph drawing to have compatible font substitutions for all the well-known fonts.</span></p>
<p><a href="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2021/10/glyph_rescale.png"><img loading="lazy" class="alignnone wp-image-47403 size-large" src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2021/10/glyph_rescale-500x214.png" alt="Comparing glyph rescaling" width="500" height="214" srcset="https://hacks.mozilla.org/files/2021/10/glyph_rescale-500x214.png 500w, https://hacks.mozilla.org/files/2021/10/glyph_rescale-250x107.png 250w, https://hacks.mozilla.org/files/2021/10/glyph_rescale-768x329.png 768w, https://hacks.mozilla.org/files/2021/10/glyph_rescale-1536x659.png 1536w, https://hacks.mozilla.org/files/2021/10/glyph_rescale.png 1602w" sizes="(max-width: 500px) 100vw, 500px" /></a></p>
<p>On the left: default font without glyph rescaling. On the right: Liberation font with glyph rescaling to emulate <span class="mx_EventTile_body" dir="auto">MyriadPro</span>.</p>
<h4>The result</h4>
<p class="c1">In the end the result turned out quite good, for example, you can now open PDFs such as <span class="c4"><a class="c6" href="https://inspection.canada.ca/DAM/DAM-food-aliments/STAGING/text-texte/c5704_re_1357758804123_eng.pdf">5704 &#8211; APPLICATION FOR A FISH EXPORT LICENCE</a></span> in Firefox 93!</p>
<h2 class="c1"><span class="c8">Making PDFs accessible</span></h2>
<h3 class="c1"><span class="c9">What is a Tagged PDF?<br />
</span></h3>
<p class="c1"><span class="c0">Early versions of PDFs were not a friendly format for accessibility tools such as screen readers. This was mainly because within a document, all text on a page is more or less absolutely positioned and there’s not a notion of a logical structure such as paragraphs, headings or sentences. There was also no way to provide a text description of images or figures. For example, some pseudo code for how a PDF may draw text:</span></p>
<pre class="js"><code>showText(“This”, 0 /*x*/, 60 /*y*/);
showText(“is”, 0, 40);
showText(“a”, 0, 20);
showText(“Heading!”, 0, 0);</code></pre>
<p class="c1"><span class="c0">This would draw text as four separate lines, but a screen reader would have no idea that they were all part of one heading. To help with accessibility, later versions of the PDF specification introduced “Tagged PDF.” This allowed PDFs to create a logical structure that screen readers could then use. One can think of this as a similar concept to an HTML hierarchy of DOM nodes. Using the example above, one could add tags:</span></p>
<pre class="js"><code>beginTag(“heading 1”);
showText(“This”, 0 /*x*/, 60 /*y*/);
showText(“is”, 0, 40);
showText(“a”, 0, 20);
showText(“Heading!”, 0, 0);
endTag(“heading 1”);</code></pre>
<p class="c1"><span class="c0">With the extra tag information, a screen reader knows that all of the lines are part of “heading 1” and can read it in a more natural fashion. The structure also allows screen readers to easily navigate to different parts of the document.</span></p>
<p class="c1"><span class="c0">The above example is only about text, but tagged PDFs support many more features than this e.g. alt text for images, table data, lists, etc.</span></p>
<h3 class="c1"><span class="c9">How we supported Tagged PDFs in PDF.js</span></h3>
<p class="c1">For tagged PDFs we leveraged the existing “text layer” and the browsers built in <span class="c4"><a class="c6" href="https://developer.mozilla.org/en-US/docs/Web/Accessibility/ARIA">HTML ARIA accessibility features</a></span><span class="c0">. We can easily see this by a simple PDF example with one heading and one paragraph. First, we generate the logical structure and insert it into the canvas:</span></p>
<pre class="html"><code>&lt;canvas id="page1"&gt;
  &lt;!-- This content is not visible, 
  but available to screen readers   --&gt;
  &lt;span role="heading" aria-level="1" aria-owns="heading_id"&gt;&lt;/span&gt;
  &lt;span aria_owns="some_paragraph"&gt;&lt;/span&gt;
&lt;/canvas&gt;</code></pre>
<p>In the text layer that overlays the canvas:</p>
<pre class="html"><code>&lt;div id="text_layer"&gt;
  &lt;span id="heading_id"&gt;Some Heading&lt;/span&gt;
  &lt;span id="some_paragaph"&gt;Hello world!&lt;/span&gt;
&lt;/div&gt;</code></pre>
<p class="c1"><span class="c0">A screen reader would then walk the DOM accessibility tree in the canvas and use the `aria-owns` attributes to find the text content for each node. For the above example, a screen reader would announce:</span></p>
<p><code>Heading Level 1 Some Heading<br />
Hello World!</code></p>
<p class="c1"><span class="c0">For those not familiar with screen readers, having this extra structure also makes navigating around the PDF much easier: you can jump from heading to heading and read paragraphs without unneeded pauses.</span></p>
<h2 class="c1"><span class="c8">Ensure there are no regressions at scale, meet reftests</span></h2>
<p><img loading="lazy" class="alignnone wp-image-47385 size-large" src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2021/09/reftest_analyzer.pn_-500x252.png" alt="Reference Test Analyzer" width="500" height="252" srcset="https://hacks.mozilla.org/files/2021/09/reftest_analyzer.pn_-500x252.png 500w, https://hacks.mozilla.org/files/2021/09/reftest_analyzer.pn_-250x126.png 250w, https://hacks.mozilla.org/files/2021/09/reftest_analyzer.pn_-768x388.png 768w, https://hacks.mozilla.org/files/2021/09/reftest_analyzer.pn_-1536x775.png 1536w, https://hacks.mozilla.org/files/2021/09/reftest_analyzer.pn_-2048x1034.png 2048w" sizes="(max-width: 500px) 100vw, 500px" /></p>
<h3>Crawling for PDFs</h3>
<p class="c1"><span class="c0">Over the past few months, we have built a web crawler to retrieve PDFs from the web and, using a set of heuristics, collect statistics about them (e.g. are they XFA? What fonts are they using? What formats of images do they include?).</span></p>
<p class="c1">We have also used the crawler with its heuristics to retrieve PDFs of interest from the <span class="c4"><a class="c6" href="https://www.pdfa.org/a-new-stressful-pdf-corpus/">“stressful PDF corpus” published by the PDF association</a></span><span class="c0">, which proved particularly interesting as they contained many corner cases we did not think could exist.</span></p>
<p class="c1">With the crawler, we were able to build a large corpus of Tagged PDFs (around 32000), PDFs using JS (around 1900), XFA PDFs (around 1200) which we could use for manual and automated testing. Kudos to our QA team for going through so many PDFs! They now know everything about asking for a fishing license in Canada, life skills!</p>
<h3>Reftests for the win</h3>
<p class="c1"><span class="c0">We did not only use the corpus for manual QA, but also added some of those PDFs to our list of reftests (reference tests).</span></p>
<p class="c1"><span class="c0">A <em><strong>reftest</strong></em> is a test consisting of a test file and a reference file. The test file uses the pdf.js rendering engine, while the reference file doesn’t (to make sure it is consistent and can’t be affected by changes in the patch the test is validating). The reference file is simply a screenshot of the rendering of a given PDF from the “master” branch of pdf.js.</span></p>
<h4>The reftest process</h4>
<p class="c1"><span class="c0">When a developer submits a change to the PDF.js repo, we run the reftests and ensure the rendering of the test file is exactly the same as the reference screenshot. If there are differences, we ensure that the differences are improvements rather than regressions.</span></p>
<p class="c1"><span class="c0">After accepting and merging a change, we regenerate the references.</span></p>
<h4>The reftest shortcomings</h4>
<p class="c1"><span class="c0">In some situations a test may have subtle differences in rendering compared to the reference due to, e.g., anti-aliasing. This introduces noise in the results, with “fake” regressions the developer and reviewer have to sift through. Sometimes, it is possible to miss real regressions because of the large number of differences to look at.</span></p>
<p class="c1"><span class="c0">Another shortcoming of reftests is that they are often big. A regression in a reftest is not as easy to investigate as a failure of a unit test.</span></p>
<p class="c1"><span class="c0">Despite these shortcomings, <strong><em>reftests are a very powerful regression prevention weapon in the pdf.js arsenal</em></strong>. The large number of reftests we have boosts our confidence when applying changes.</span></p>
<h2 class="c1"><span class="c8">Conclusion<br />
</span></h2>
<p class="c1">Support for AcroForms landed in Firefox v84. JavaScript execution in v88. Tagged PDFs in v89. XFA forms in v93 (tomorrow, October 5th, 2021!).</p>
<p class="c1">While all of these features have greatly improved form usability and accessibility, there are still more features we’d like to add. If you’re interested in helping, we’re always looking for more contributors and you can join us on <a href="https://chat.mozilla.org/#/room/#pdfjs:mozilla.org">element</a> or <a href="https://github.com/mozilla/pdf.js">github</a>.</p>
<p>We also want to say a big thanks to two of our contributors <a href="https://github.com/Snuffleupagus">Jonas Jenwald</a> and <a href="https://github.com/timvandermeij">Tim van der Meij</a> for their on going help with the above projects.</p>
    <section class="about">
                                <h2 class="about__header">About
                          <a class="url" href="https://adriftwith.me" rel="external me">
                bdahl              </a>
                      </h3>
                    <ul class="author-meta fa-ul"><li><i class="fa-li fa fa-globe"></i><a href="https://adriftwith.me" class="website" rel="me">https://adriftwith.me</a></li></ul>            <p><a class="url" href="https://hacks.mozilla.org/author/bdahlmozilla-com/">More articles by bdahl&hellip;</a></p>
                  <h2 class="about__header">About
                          Calixte Denizet                      </h3>
                                <p><a class="url" href="https://hacks.mozilla.org/author/cdenizetmozilla-com/">More articles by Calixte Denizet&hellip;</a></p>
                  <h2 class="about__header">About
                          <a class="url" href="https://marco-c.github.io/" rel="external me">
                Marco Castelluccio              </a>
                      </h3>
                      <p>Marco is a passionate Mozilla hackeneer (a strange hybrid between hacker and engineer), who contributed and keeps contributing to Firefox, PluotSorbet, Open Web Apps. More recently he has been working on using machine learning and data mining techniques for software engineering (testing, crash handling, bug management, and so on).</p>
                    <ul class="author-meta fa-ul"><li><i class="fa-li fa fa-globe"></i><a href="https://marco-c.github.io/" class="website" rel="me">https://marco-c.github.io/</a></li></ul>            <p><a class="url" href="https://hacks.mozilla.org/author/mcastellucciomozilla-com/">More articles by Marco Castelluccio&hellip;</a></p>
                  </section>
  </article>
  <section class="promo">
    <form id="newsletterForm" name="newsletter-form" class="newsletter block block--1 block--polite" action="https://www.mozilla.org/en-US/newsletter/" method="post">
  <h2 class="heading">Discover great resources for web development</h2>
  <p class="newsletter__description">Sign up for the Mozilla Developer Newsletter:</p>
  <input id="fmt" name="fmt" value="H" type="hidden">
  <input id="newsletterNewslettersInput" name="newsletters" value="app-dev" type="hidden">

  <div id="newsletterErrors" class="newsletter__errors"></div>

  <div id="newsletterEmail" class="form__row">
    <label for="newsletterEmailInput" class="offscreen">E-mail</label>
    <input id="newsletterEmailInput" name="email" class="newsletter__input" required="" placeholder="you@example.com" size="30" type="email">
  </div>

  <div id="newsletterPrivacy" class="form__row form__fineprint">
    <input id="newsletterPrivacyInput" name="privacy" required="" type="checkbox">
    <label for="newsletterPrivacyInput">
      I'm okay with Mozilla handling my info as explained in this <a href="https://www.mozilla.org/privacy/">Privacy Policy</a>.
    </label>
  </div>
  <button id="newsletter-submit" type="submit" class="button positive">Sign up now</button>
</form>
<div id="newsletterThanks" class="newsletter newsletter--thanks block block--1 block--polite hidden">
  <h2 class="heading">Thanks! Please check your inbox to confirm your subscription.</h2>
  <p>If you haven’t previously confirmed a subscription to a Mozilla-related newsletter you may have to do so. Please check your inbox or your spam filter for an email from us.
  </p>
</div>
  </section>
  

<section class="discussion">
  <hr class="dino">
  <div class="comments">
    <header class="comments__head">
      <h3>3 comments</h3>
    </header>

          <ol class="comments__list" class="hfeed">
      
 <li id="comment-27234" class="comment even thread-even depth-1">
      <b class="comment__title vcard">
      <cite class="author fn">Sascha</cite>
    </b>
  
    
    <blockquote class="comment__body">
      <p>Are there any plans to introduce accessibility support for untagged PDFs into Firefox? As a screen-reader user, I often have to jump between multiple PDF viewers based on weather and how PDFs are tagged to get the best experience, and if FF could get something like the untagged accessibility of PDFs in Edge, that would be fantastic</p>
    </blockquote>

    <a class="comment__meta" href="https://hacks.mozilla.org/2021/10/implementing-form-filling-and-accessibility-in-the-firefox-pdf-viewer/#comment-27234" rel="bookmark" title="Permanent link to this comment by Sascha"><abbr class="published" title="2021-10-07">October 7th, 2021</abbr> at 13:16</a>

      <p class="comment__util"> </p>
  </li><!-- #comment-## -->

 <li id="comment-27238" class="comment odd alt thread-odd thread-alt depth-1">
      <b class="comment__title vcard">
      <cite class="author fn">Curtis Wilcox</cite>
    </b>
  
    
    <blockquote class="comment__body">
      <p>Thanks for the explanation, that&#8217;s an unexpected use of `aria-owns`. It looks like the attribute is well-supported by most screen reader &amp; browser combinations but not at all supported by Apple&#8217;s VoiceOver.</p>
<p><a href="https://a11ysupport.io/tech/aria/aria-owns_attribute" rel="nofollow ugc">https://a11ysupport.io/tech/aria/aria-owns_attribute</a></p>
<p>BTW, there&#8217;s a typo in the code sample, the attribute is `aria-owns`, not `aria_owns`.</p>
    </blockquote>

    <a class="comment__meta" href="https://hacks.mozilla.org/2021/10/implementing-form-filling-and-accessibility-in-the-firefox-pdf-viewer/#comment-27238" rel="bookmark" title="Permanent link to this comment by Curtis Wilcox"><abbr class="published" title="2021-10-07">October 7th, 2021</abbr> at 13:35</a>

      <p class="comment__util"> </p>
  </li><!-- #comment-## -->

 <li id="comment-27241" class="comment even thread-even depth-1">
      <b class="comment__title vcard">
      <cite class="author fn">Keith Gross</cite>
    </b>
  
    
    <blockquote class="comment__body">
      <p>As a developer who formerly developed XFA forms I can only implore you humbly to delete all your XFA code and do whatever you must to forget it ever existed. The Adobe XFA code was riddled with inconsistencies and corner cases that mean that no other implementation will ever be more than 90% compatible for anything but relatively simple forms. Having another application the purports to support these forms will only prolong the death of XFA. I beg you not to do that to the world.</p>
    </blockquote>

    <a class="comment__meta" href="https://hacks.mozilla.org/2021/10/implementing-form-filling-and-accessibility-in-the-firefox-pdf-viewer/#comment-27241" rel="bookmark" title="Permanent link to this comment by Keith Gross"><abbr class="published" title="2021-10-08">October 8th, 2021</abbr> at 04:28</a>

      <p class="comment__util"> </p>
  </li><!-- #comment-## -->
      </ol>
      </div>

<p class="comments__closed"><b>Comments are closed for this article.</b></p>


</main><!-- /#content-main -->

  

    <footer class="footer section section--fullwidth">
      <div class="row">
        <p class="block block--1">
          Except where otherwise noted, content on this site is licensed
          under the
          <a href="https://creativecommons.org/licenses/by-sa/3.0/" rel="license external">Creative Commons Attribution Share-Alike License v3.0</a>
          or any later version.
        </p>
        <img class="footer__logo" alt="the Mozilla dino logo" src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-content/themes/Hax/img/dino.svg">
      </div>
    </footer>
  </div>
  <link rel='stylesheet' id='hljstheme-css'  href='https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-content/plugins/wp-code-highlightjs/styles/solarized-light.css?ver=0.6.2' type='text/css' media='all' />
<script type='text/javascript' src='https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-includes/js/wp-embed.min.js?ver=5.8.2' id='wp-embed-js'></script>
<script type='text/javascript' src='https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-content/plugins/wp-code-highlightjs/highlight.common.pack.js?ver=0.6.2' id='hljs_preload-js'></script>
<script type='text/javascript' src='https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-content/plugins/wp-code-highlightjs/highlight.custom.pack.js?ver=0.6.2' id='hljs-js'></script>
    <style>pre.hljs {padding: 5px;}
pre.hljs code {}</style>
    <script type="text/javascript">
    (function($, window) {
        var init_fn_flag = false;
        var init_fn = (function() {
            if (init_fn_flag)
                return;
            init_fn_flag = true;
             hljs.configure({"tabReplace":"    "});
            $('pre code').each(function(i, block) {
                hljs.highlightBlock(block);
            });
        });
        $(document).ready(init_fn);
        $(window).on("load", init_fn);
    })(jQuery, window);
    </script>
  <script>
    // External links should open in a new tab.
    (function () {
      var postLinks = document.querySelectorAll('#content-main a');

      var origin = location.origin;

      for (var i = 0; i < postLinks.length; i++) {
        var link = postLinks[i];
        if (link.origin !== origin && !link.getAttribute('target')) {
          link.setAttribute('target', '_blank');
        }
      }
    })();

    window.addEventListener('load', function () {
      if (document.querySelector('#newsletterForm')) {
        var script = document.createElement('script');
        var path = document.head.getAttribute('data-template-path');
        script.setAttribute('src', path + '/js/newsletter.js');
        document.head.appendChild(script);
      }
    });
  </script>
</body>
</html>
