

<!doctype html>
<html lang="en-US">
<head data-template-path="https://hacks.mozilla.org/wp-content/themes/Hax">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="google-site-verification" content="w2ocEMd5yV9IsGCjhq-7ls67r4VH-Ob6oWdiZpqjN8U">

  
  <meta name="title" content="Retrospective and Technical Details on the recent Firefox Outage – Mozilla Hacks - the Web developer blog">

    <meta property="og:site_name" content="Mozilla Hacks &#8211; the Web developer blog">
  <meta property="og:url" content="https://hacks.mozilla.org/2022/02/retrospective-and-technical-details-on-the-recent-firefox-outage">
  <meta property="og:title" content="Retrospective and Technical Details on the recent Firefox Outage – Mozilla Hacks - the Web developer blog">
  <meta property="og:description" content="On January 13th 2022, Firefox became unusable for close to two hours for users worldwide. This post highlights the complex series of events and circumstances that, together, triggered a bug deep in the networking code of Firefox.">
  <meta property="og:image" content="https://hacks.mozilla.org/wp-content/themes/Hax/img/hacks-meta-image.jpg">

    <meta property="twitter:title" content="Retrospective and Technical Details on the recent Firefox Outage – Mozilla Hacks - the Web developer blog">
  <meta property="twitter:description" content="On January 13th 2022, Firefox became unusable for close to two hours for users worldwide. This post highlights the complex series of events and circumstances that, together, triggered a bug deep in the networking code of Firefox.">
  <meta name="twitter:card" content="summary_large_image">
  <meta property="twitter:image" content="https://hacks.mozilla.org/wp-content/themes/Hax/img/hacks-meta-image.jpg">
  <meta name="twitter:site" content="@mozhacks">

  <link href='//fonts.googleapis.com/css?family=Open+Sans:400,400italic,700,700italic' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-content/themes/Hax/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-content/themes/Hax/style.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/highlight.js/8.6.0/styles/solarized_light.min.css">

  <script type="text/javascript">
    window.hacks = {};
    // http://cfsimplicity.com/61/removing-analytics-clutter-from-campaign-urls
    var removeUtms  =   function(){
        var l = window.location;
        if( l.hash.indexOf( "utm" ) != -1 ){
            var anchor = l.hash.match(/#(?!utm)[^&]+/);
            anchor  =   anchor? anchor[0]: '';
            if(!anchor && window.history.replaceState){
                history.replaceState({},'', l.pathname + l.search);
            } else {
                l.hash = anchor;
            }
        };
    };

    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-35433268-8'],
              ['_setAllowAnchor', true]);
    _gaq.push (['_gat._anonymizeIp']);
    _gaq.push(['_trackPageview']);
    _gaq.push( removeUtms );
    (function(d, k) {
      var ga = d.createElement(k); ga.type = 'text/javascript'; ga.async = true;
      ga.src = 'https://ssl.google-analytics.com/ga.js';
      var s = d.getElementsByTagName(k)[0]; s.parentNode.insertBefore(ga, s);
    })(document, 'script');
  </script>

  <meta name='robots' content='index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1' />
<meta name="blog-name" content="Mozilla Hacks - the Web developer blog" />
<link rel="alternate" hreflang="en" href="https://hacks.mozilla.org/2022/02/retrospective-and-technical-details-on-the-recent-firefox-outage/" />
<link rel="alternate" hreflang="x-default" href="https://hacks.mozilla.org/2022/02/retrospective-and-technical-details-on-the-recent-firefox-outage/" />

	<!-- This site is optimized with the Yoast SEO plugin v17.5 - https://yoast.com/wordpress/plugins/seo/ -->
	<title>Retrospective and Technical Details on the recent Firefox Outage - Mozilla Hacks - the Web developer blog</title>
	<meta name="description" content="On January 13th 2022, Firefox became unusable for close to two hours for users worldwide. This post highlights the complex series of events and circumstances that, together, triggered a bug deep in the networking code of Firefox." />
	<link rel="canonical" href="https://hacks.mozilla.org/2022/02/retrospective-and-technical-details-on-the-recent-firefox-outage/" />
	<meta name="twitter:label1" content="Written by" />
	<meta name="twitter:data1" content="Christian Holler" />
	<meta name="twitter:label2" content="Est. reading time" />
	<meta name="twitter:data2" content="7 minutes" />
	<script type="application/ld+json" class="yoast-schema-graph">{"@context":"https://schema.org","@graph":[{"@type":"WebSite","@id":"https://hacks.mozilla.org/#website","url":"https://hacks.mozilla.org/","name":"Mozilla Hacks - the Web developer blog","description":"hacks.mozilla.org","potentialAction":[{"@type":"SearchAction","target":{"@type":"EntryPoint","urlTemplate":"https://hacks.mozilla.org/?s={search_term_string}"},"query-input":"required name=search_term_string"}],"inLanguage":"en-US"},{"@type":"ImageObject","@id":"https://hacks.mozilla.org/2022/02/retrospective-and-technical-details-on-the-recent-firefox-outage/#primaryimage","inLanguage":"en-US","url":"https://hacks.mozilla.org/files/2022/01/crashes-foxstuck2.png","contentUrl":"https://hacks.mozilla.org/files/2022/01/crashes-foxstuck2.png","width":3490,"height":1612,"caption":"Backlog of pending crash reports building up and reaching close to 300K unprocessed reports."},{"@type":"WebPage","@id":"https://hacks.mozilla.org/2022/02/retrospective-and-technical-details-on-the-recent-firefox-outage/#webpage","url":"https://hacks.mozilla.org/2022/02/retrospective-and-technical-details-on-the-recent-firefox-outage/","name":"Retrospective and Technical Details on the recent Firefox Outage - Mozilla Hacks - the Web developer blog","isPartOf":{"@id":"https://hacks.mozilla.org/#website"},"primaryImageOfPage":{"@id":"https://hacks.mozilla.org/2022/02/retrospective-and-technical-details-on-the-recent-firefox-outage/#primaryimage"},"datePublished":"2022-02-02T09:00:50+00:00","dateModified":"2022-02-02T09:20:54+00:00","author":{"@id":"https://hacks.mozilla.org/#/schema/person/a01f5bc7e8ed9c102654ad65f4a11ff9"},"description":"On January 13th 2022, Firefox became unusable for close to two hours for users worldwide. This post highlights the complex series of events and circumstances that, together, triggered a bug deep in the networking code of Firefox.","breadcrumb":{"@id":"https://hacks.mozilla.org/2022/02/retrospective-and-technical-details-on-the-recent-firefox-outage/#breadcrumb"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://hacks.mozilla.org/2022/02/retrospective-and-technical-details-on-the-recent-firefox-outage/"]}]},{"@type":"BreadcrumbList","@id":"https://hacks.mozilla.org/2022/02/retrospective-and-technical-details-on-the-recent-firefox-outage/#breadcrumb","itemListElement":[{"@type":"ListItem","position":1,"name":"Home","item":"https://hacks.mozilla.org/"},{"@type":"ListItem","position":2,"name":"Articles","item":"https://hacks.mozilla.org/articles/"},{"@type":"ListItem","position":3,"name":"Retrospective and Technical Details on the recent Firefox Outage"}]},{"@type":"Person","@id":"https://hacks.mozilla.org/#/schema/person/a01f5bc7e8ed9c102654ad65f4a11ff9","name":"Christian Holler","image":{"@type":"ImageObject","@id":"https://hacks.mozilla.org/#personlogo","inLanguage":"en-US","url":"https://secure.gravatar.com/avatar/b29b83d12aba827b8ff68296e473bec5?s=96&d=mm&r=g","contentUrl":"https://secure.gravatar.com/avatar/b29b83d12aba827b8ff68296e473bec5?s=96&d=mm&r=g","caption":"Christian Holler"},"description":"Christian is a Firefox Tech Lead and Senior Staff Security Engineer at Mozilla.","sameAs":["https://twitter.com/mozdeco"],"url":"https://hacks.mozilla.org/author/chollermozilla-com/"}]}</script>
	<!-- / Yoast SEO plugin. -->


<link rel='dns-prefetch' href='//blog.mozilla.org' />
<link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="Mozilla Hacks - the Web developer blog &raquo; Feed" href="https://hacks.mozilla.org/feed/" />
<link rel="alternate" type="application/rss+xml" title="Mozilla Hacks - the Web developer blog &raquo; Comments Feed" href="https://hacks.mozilla.org/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="Mozilla Hacks - the Web developer blog &raquo; Retrospective and Technical Details on the recent Firefox Outage Comments Feed" href="https://hacks.mozilla.org/2022/02/retrospective-and-technical-details-on-the-recent-firefox-outage/feed/" />
<link rel='stylesheet' id='wp-block-library-css'  href='https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-includes/css/dist/block-library/style.min.css?ver=5.8.3' type='text/css' media='all' />
<link rel='stylesheet' id='mediaelement-css'  href='https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-includes/js/mediaelement/mediaelementplayer-legacy.min.css?ver=4.2.16' type='text/css' media='all' />
<link rel='stylesheet' id='wp-mediaelement-css'  href='https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-includes/js/mediaelement/wp-mediaelement.min.css?ver=5.8.3' type='text/css' media='all' />
<link rel='stylesheet' id='wpml-legacy-post-translations-0-css'  href='//blog.mozilla.org/hacks/wp-content/plugins/sitepress-multilingual-cms/templates/language-switchers/legacy-post-translations/style.min.css?ver=1' type='text/css' media='all' />
<script type='text/javascript' src='https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-includes/js/jquery/jquery.min.js?ver=3.6.0' id='jquery-core-js'></script>
<script type='text/javascript' src='https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-includes/js/jquery/jquery-migrate.min.js?ver=3.3.2' id='jquery-migrate-js'></script>
<script type='text/javascript' src='https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-content/themes/Hax/js/fc-checkcomment.js?ver=5.8.3' id='checkcomments-js'></script>
<script type='text/javascript' src='https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-content/themes/Hax/js/analytics.js?ver=5.8.3' id='analytics-js'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://hacks.mozilla.org/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://hacks.mozilla.org/wp-includes/wlwmanifest.xml" /> 
<link rel='shortlink' href='https://hacks.mozilla.org/?p=47574' />
<link rel="alternate" type="application/json+oembed" href="https://hacks.mozilla.org/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fhacks.mozilla.org%2F2022%2F02%2Fretrospective-and-technical-details-on-the-recent-firefox-outage%2F" />
<link rel="alternate" type="text/xml+oembed" href="https://hacks.mozilla.org/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fhacks.mozilla.org%2F2022%2F02%2Fretrospective-and-technical-details-on-the-recent-firefox-outage%2F&#038;format=xml" />
<meta name="generator" content="WPML ver:4.5.1 stt:59,61,1,2;" />
<link rel="shortcut icon" type="image/x-icon" href="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-content/themes/Hax/favicon.ico" /><style>#wpadminbar #wp-admin-bar-site-name>.ab-item:before { content: none !important;}li#wp-admin-bar-site-name a { background: url( "https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-content/themes/Hax/favicon.ico" ) left center/20px no-repeat !important; padding-left: 21px !important; background-size: 20px !important; } li#wp-admin-bar-site-name { margin-left: 5px !important; } li#wp-admin-bar-site-name {} #wp-admin-bar-site-name div a { background: none !important; }
</style></head>
<body>
  <div class="outer-wrapper">
    <header class="section section--fullwidth header">
      <div class="masthead row">
        <div class="branding block block--3">
          <h1>
            <a href="https://hacks.mozilla.org">
              <img class="branding__logo" src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-content/themes/Hax/img/mdn-logo-mono.svg">
              <img class="branding__wordmark" src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-content/themes/Hax/img/wordmark.svg" alt="Mozilla">
              <span class="branding__title">Hac<span class="logo-askew">k</span>s</span>
            </a>
          </h1>
        </div>
        <div class="search block block--2">
          <form class="search__form" method="get" action="https://hacks.mozilla.org/">
            <input type="search" name="s" class="search__input" placeholder="Search Mozilla Hacks" value="">
            <i class="fa fa-search search__badge"></i>
          </form>
        </div>
        <nav class="social">
          <a class="social__link youtube" href="http://www.youtube.com/user/mozhacks" title="YouTube"><i class="fa fa-youtube" aria-hidden="true"></i><span>Hacks on YouTube</span></a>
          <a class="social__link twitter" href="https://twitter.com/mozhacks" title="Twitter"><i class="fa fa-twitter" aria-hidden="true"></i><span>@mozhacks on Twitter</span></a>
          <a class="social__link rss" href="https://hacks.mozilla.org/feed/" title="RSS Feed"><i class="fa fa-rss" aria-hidden="true"></i><span>Hacks RSS Feed</span></a>
          <a class="fx-button" href="https://www.mozilla.org/firefox/download/thanks/?utm_source=hacks.mozilla.org&utm_medium=referral&utm_campaign=header-download-button&utm_content=header-download-button">Download Firefox</a>
        </nav>
      </div>
    </header>

  
<div id="content-head" class="section">
  <h1 class="post__title">Retrospective and Technical Details on the recent Firefox Outage</h1>
  <div class="byline">
    <h3 class="post__author">
                      <img alt='' src='https://secure.gravatar.com/avatar/b29b83d12aba827b8ff68296e473bec5?s=64&#038;d=mm&#038;r=g' srcset='https://secure.gravatar.com/avatar/b29b83d12aba827b8ff68296e473bec5?s=128&#038;d=mm&#038;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' loading='lazy'/>        By
                                        <a class="url" href="https://hacks.mozilla.org/author/chollermozilla-com/">Christian Holler</a>                            </h2>
    <div class="post__meta">
      Posted on
      <abbr class="published" title="2022-02-02T01:00:50-08:00">
        February 2, 2022      </abbr>
      <span class="entry-cat">in
        <a href="https://hacks.mozilla.org/category/firefox/" rel="category tag" title="View all posts in Firefox" >Firefox</a>      </span>
            <div class="socialshare" data-type="bubbles"></div>
    </div>
  </div>
</div>

<main id="content-main" class="section article">
  <article class="post" role="article">
    <p>On January 13th 2022, Firefox became unusable for close to two hours for users worldwide. This incident interrupted many people’s workflow. This post highlights the complex series of events and circumstances that, together, triggered a bug deep in the networking code of Firefox.<span id="more-47574"></span></p>
<h2>What Happened?</h2>
<p align="justify">Firefox has a number of servers and related infrastructure that handle several internal services. These include updates, telemetry, certificate management, crash reporting and other similar functionality. This infrastructure is hosted by different cloud service providers that use load balancers to distribute the load evenly across servers. For those services hosted on Google Cloud Platform (GCP) these load balancers have settings related to the HTTP protocol they should advertise and one of these settings is HTTP/3 support with three states: “Enabled”, “Disabled” or “Automatic (default)”. Our load balancers were set to the “Automatic (default)” setting and on January 13, 2022 at 07:28 UTC, GCP deployed an unannounced change to make HTTP/3 the default. As Firefox uses HTTP/3 when supported, from that point forward, some connections that Firefox makes to the services infrastructure would use HTTP/3 instead of the previously used HTTP/2 protocol.<a id="footnote1">¹</a></p>
<p align="justify">Shortly after, we noticed a spike in crashes being reported through our crash reporter and also received several reports from inside and outside of Mozilla describing a hang of the browser.</p>
<div id="attachment_47575" style="width: 610px" class="wp-caption aligncenter"><img aria-describedby="caption-attachment-47575" loading="lazy" class="size-full wp-image-47575" src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2022/01/crashes-foxstuck2.png" alt="A graph showing the curve of unprocessed crash reports quickly growing." width="3490" height="1612" srcset="https://hacks.mozilla.org/files/2022/01/crashes-foxstuck2.png 3490w, https://hacks.mozilla.org/files/2022/01/crashes-foxstuck2-250x115.png 250w, https://hacks.mozilla.org/files/2022/01/crashes-foxstuck2-500x231.png 500w, https://hacks.mozilla.org/files/2022/01/crashes-foxstuck2-768x355.png 768w, https://hacks.mozilla.org/files/2022/01/crashes-foxstuck2-1536x709.png 1536w, https://hacks.mozilla.org/files/2022/01/crashes-foxstuck2-2048x946.png 2048w" sizes="(max-width: 3490px) 100vw, 3490px" /><p id="caption-attachment-47575" class="wp-caption-text"><small> Backlog of pending crash reports building up and reaching close to 300K unprocessed reports.</small></p></div>
<p align="justify">As part of the incident response process, we quickly discovered that the client was hanging inside a network request to one of the Firefox internal services. However, at this point we neither had an explanation for why this would trigger just now, nor what the scope of the problem was. We continued to look for the “trigger” — some change that must have occurred to start the problem. We found that we had not shipped updates or configuration changes that could have caused this problem. At the same time, we were keeping in mind that HTTP/3 had been enabled since Firefox 88 and was actively used by some popular websites.</p>
<p align="justify">Although we couldn’t see it, we suspected that there had been some kind of “invisible” change rolled out by one of our cloud providers that somehow modified load balancer behavior. On closer inspection, none of our settings were changed. We then discovered through logs that for some reason, the load balancers for our Telemetry service were serving HTTP/3 connections while they hadn’t done that before. We disabled HTTP/3 explicitly on GCP at 09:12 UTC. This unblocked our users, but we were not yet certain about the root cause and without knowing that, it was impossible for us to tell if this would affect additional HTTP/3 connections.</p>
<p align="justify"><small><a href="#footnote1">¹</a> <i>Some highly critical services such as updates use a special <code>beConservative</code> flag that prevents the use of any experimental technology for their connections (e.g. HTTP/3).</i></small></p>
<h2>A Special Mix of Ingredients</h2>
<p align="justify">It quickly became clear to us that there must be some combination of special circumstances for the hang to occur. We performed a number of tests with various tools and remote services and were not able to reproduce the problem, not even with a regular connection to the Telemetry staging server (a server only used for testing deployments, which we had left in its original configuration for testing purposes). With Firefox itself, however, we were able to reproduce the issue with the staging server.</p>
<p align="justify">After further debugging, we found the “special ingredient” required for this bug to happen. All HTTP/3 connections go through Necko, our networking stack. However, Rust components that need direct network access are not using Necko directly, but are calling into it through an intermediate library called <a href="https://github.com/mozilla/application-services/tree/main/components/viaduct"><i><code>viaduct</code></i></a>.</p>
<p align="justify">In order to understand why this mattered, we first need to understand some things about the internals of Necko, in particular about HTTP/3 upload requests. For such requests, the higher-level Necko APIs<a id="footnote2">²</a> check if the <code>Content-Length</code> header is present and if it isn&#8217;t, it will automatically be added. The lower-level HTTP/3 code later relies on this header to determine the request size. This works fine for web content and other requests in our code.</p>
<p align="justify">When requests pass through <code>viaduct</code> first, however, <code>viaduct</code> will lower-case each header and pass it on to Necko. And here is the problem: the API checks in Necko are case-<b>insensitive</b> while the lower-level HTTP/3 code is case-<b>sensitive</b>. So if any code was to add a <code>Content-Length</code> header and pass the request through <code>viaduct</code>, it would pass the Necko API checks but the HTTP/3 code would not find the header.</p>
<p align="justify">It just so happens that Telemetry is currently the only Rust-based component in Firefox Desktop that uses the network stack and adds a <code>Content-Length</code> header. This is why users who disabled Telemetry would see this problem resolved even though the problem is not related to Telemetry functionality itself and could have been triggered otherwise.</p>
<div id="attachment_47579" style="width: 610px" class="wp-caption aligncenter"><img aria-describedby="caption-attachment-47579" loading="lazy" class="size-full wp-image-47579" src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2022/01/foxstuck-diagram4.png" alt="A diagram showing the different network components in Firefox." width="1826" height="973" srcset="https://hacks.mozilla.org/files/2022/01/foxstuck-diagram4.png 1826w, https://hacks.mozilla.org/files/2022/01/foxstuck-diagram4-250x133.png 250w, https://hacks.mozilla.org/files/2022/01/foxstuck-diagram4-500x266.png 500w, https://hacks.mozilla.org/files/2022/01/foxstuck-diagram4-768x409.png 768w, https://hacks.mozilla.org/files/2022/01/foxstuck-diagram4-1536x818.png 1536w" sizes="(max-width: 1826px) 100vw, 1826px" /><p id="caption-attachment-47579" class="wp-caption-text"><small> A specific code path was required to trigger the problem in the HTTP/3 protocol implementation.</small></p></div>
<p align="justify"><small><a href="#footnote2">²</a> <i>These are internal APIs, not accessible to web content.</i></small></p>
<h2>The Infinite Loop</h2>
<p align="justify">With the load balancer change in place, and a special code path in a new Rust service now active, the necessary final ingredient to trigger the problem for users was deep in Necko HTTP/3 code.</p>
<p align="justify">When handling a request, the code <a href="https://searchfox.org/mozilla-central/rev/435a77f1a1aaf1a78d30a2aaa81c6158a2f83dba/netwerk/protocol/http/Http3Stream.cpp#71,79-83">looked up the field in a case-sensitive way</a> and failed to find the header as it had been lower-cased by <code>viaduct</code>. Without the header, the request was determined by the Necko code to be complete, leaving the real request body unsent. However, this code would only terminate when there was no additional content to send. This <a href="https://searchfox.org/mozilla-central/rev/435a77f1a1aaf1a78d30a2aaa81c6158a2f83dba/netwerk/protocol/http/Http3Stream.cpp#223,228,272-274">unexpected state caused the code to loop indefinitely rather than returning an error</a>. Because all network requests go through one <i>socket thread</i>, this loop blocked any further network communication and made Firefox unresponsive, unable to load web content.</p>
<h2>Lessons Learned</h2>
<p align="justify">As so often is the case, the issue was a lot more complex than it appeared at first glance and there were many contributing factors working together. Some of the key factors we have identified include:</p>
<ul>
<li aria-level="1">
<p align="justify">GCP’s deployment of HTTP/3 as default was unannounced. We are actively working with them to improve the situation. We realize that an announcement (as is usually sent) might not have entirely mitigated the risk of an incident, but it would likely have triggered more controlled experiments (e.g. in a staging environment) and deployment.</p>
</li>
<li aria-level="1">
<p align="justify">Our setting of “Automatic (default)” on the load balancers instead of a more explicit choice allowed the deployment to take place automatically. We are reviewing all service configurations to avoid similar mistakes in the future.</p>
</li>
<li aria-level="1">
<p align="justify">The particular combination of HTTP/3 and <code>viaduct</code> on Firefox Desktop was not covered in our continuous integration system. While we cannot test every possible combination of configurations and components, the choice of HTTP version is a fairly major change that should have been tested, as well as the use of an additional networking layer like <code>viaduct</code>. Current HTTP/3 tests cover the low-level protocol behavior and the Necko layer as it is used by web content. We should run more system tests with different HTTP versions and doing so could have revealed this problem.</p>
</li>
</ul>
<p align="justify">We are also investigating action points both to make the browser more resilient towards such problems and to make incident response even faster. Learning as much as possible from this incident will help us improve the quality of our products. We’re grateful to all the users who have sent crash reports, worked with us in Bugzilla or helped others to work around the problem.</p>
    <section class="about">
                                <h2 class="about__header">About
                          Christian Holler                      </h3>
                      <p>Christian is a Firefox Tech Lead and Senior Staff Security Engineer at Mozilla.</p>
                    <ul class="author-meta fa-ul"><li><i class="fa-li fa fa-twitter"></i><a href="http://twitter.com/mozdeco" class="twitter" rel="me">@mozdeco</a></li></ul>            <p><a class="url" href="https://hacks.mozilla.org/author/chollermozilla-com/">More articles by Christian Holler&hellip;</a></p>
                  </section>
  </article>
  <section class="promo">
    <form id="newsletterForm" name="newsletter-form" class="newsletter block block--1 block--polite" action="https://www.mozilla.org/en-US/newsletter/" method="post">
  <h2 class="heading">Discover great resources for web development</h2>
  <p class="newsletter__description">Sign up for the Mozilla Developer Newsletter:</p>
  <input id="fmt" name="fmt" value="H" type="hidden">
  <input id="newsletterNewslettersInput" name="newsletters" value="app-dev" type="hidden">

  <div id="newsletterErrors" class="newsletter__errors"></div>

  <div id="newsletterEmail" class="form__row">
    <label for="newsletterEmailInput" class="offscreen">E-mail</label>
    <input id="newsletterEmailInput" name="email" class="newsletter__input" required="" placeholder="you@example.com" size="30" type="email">
  </div>

  <div id="newsletterPrivacy" class="form__row form__fineprint">
    <input id="newsletterPrivacyInput" name="privacy" required="" type="checkbox">
    <label for="newsletterPrivacyInput">
      I'm okay with Mozilla handling my info as explained in this <a href="https://www.mozilla.org/privacy/">Privacy Policy</a>.
    </label>
  </div>
  <button id="newsletter-submit" type="submit" class="button positive">Sign up now</button>
</form>
<div id="newsletterThanks" class="newsletter newsletter--thanks block block--1 block--polite hidden">
  <h2 class="heading">Thanks! Please check your inbox to confirm your subscription.</h2>
  <p>If you haven’t previously confirmed a subscription to a Mozilla-related newsletter you may have to do so. Please check your inbox or your spam filter for an email from us.
  </p>
</div>
  </section>
  

<section class="discussion">
  <hr class="dino">
  <div class="comments">
    <header class="comments__head">
      <h3>3 comments</h3>
    </header>

          <ol class="comments__list" class="hfeed">
      
 <li id="comment-27373" class="comment even thread-even depth-1">
      <b class="comment__title vcard">
      <cite class="author fn">Sjors</cite>
    </b>
  
    
    <blockquote class="comment__body">
      <p>Excellent explanation of the issue. Very interesting read.</p>
    </blockquote>

    <a class="comment__meta" href="https://hacks.mozilla.org/2022/02/retrospective-and-technical-details-on-the-recent-firefox-outage/#comment-27373" rel="bookmark" title="Permanent link to this comment by Sjors"><abbr class="published" title="2022-02-02">February 2nd, 2022</abbr> at 01:37</a>

      <p class="comment__util"><a rel='nofollow' class='comment-reply-link' href='#comment-27373' data-commentid="27373" data-postid="47574" data-belowelement="comment-27373" data-respondelement="respond" data-replyto="Reply to Sjors" aria-label='Reply to Sjors'>Reply</a> </p>
  </li><!-- #comment-## -->

 <li id="comment-27374" class="comment odd alt thread-odd thread-alt depth-1">
      <b class="comment__title vcard">
      <cite class="author fn">Jesper</cite>
    </b>
  
    
    <blockquote class="comment__body">
      <p>Why isn&#8217;t one of the lessons learned to treat headers in a case-insensitive way? That&#8217;s how they are supposed to be treated according to every HTTP standard, after all, and it would have avoided the issue in this case.</p>
    </blockquote>

    <a class="comment__meta" href="https://hacks.mozilla.org/2022/02/retrospective-and-technical-details-on-the-recent-firefox-outage/#comment-27374" rel="bookmark" title="Permanent link to this comment by Jesper"><abbr class="published" title="2022-02-02">February 2nd, 2022</abbr> at 01:40</a>

      <p class="comment__util"><a rel='nofollow' class='comment-reply-link' href='#comment-27374' data-commentid="27374" data-postid="47574" data-belowelement="comment-27374" data-respondelement="respond" data-replyto="Reply to Jesper" aria-label='Reply to Jesper'>Reply</a> </p>
  <ol class="children">

 <li id="comment-27375" class="comment byuser comment-author-chollermozilla-com bypostauthor even depth-2">
      <b class="comment__title vcard">
      <cite class="author fn">Christian Holler</cite>
    </b>
  
    
    <blockquote class="comment__body">
      <p>Headers are already treated in this way and the one place where the check was case-sensitive was simply a bug that could only be triggered by internal code, so it went undetected.</p>
    </blockquote>

    <a class="comment__meta" href="https://hacks.mozilla.org/2022/02/retrospective-and-technical-details-on-the-recent-firefox-outage/#comment-27375" rel="bookmark" title="Permanent link to this comment by Christian Holler"><abbr class="published" title="2022-02-02">February 2nd, 2022</abbr> at 02:03</a>

      <p class="comment__util"><a rel='nofollow' class='comment-reply-link' href='#comment-27375' data-commentid="27375" data-postid="47574" data-belowelement="comment-27375" data-respondelement="respond" data-replyto="Reply to Christian Holler" aria-label='Reply to Christian Holler'>Reply</a> </p>
  </li><!-- #comment-## -->
</ol><!-- .children -->
</li><!-- #comment-## -->
      </ol>
      </div>
  <div class="response" id="respond">
        <form id="comment-form" action="https://hacks.mozilla.org/wp-comments-post.php" method="post">
        <h3>Post Your Comment</h3>
        <p id="cancel-comment-reply"><a rel="nofollow" id="cancel-comment-reply-link" href="/2022/02/retrospective-and-technical-details-on-the-recent-firefox-outage/#respond" style="display:none;">Cancel Reply</a></p>
              <div class="field" id="cmt-name">
          <label for="author">Your name <abbr title="(required)">*</abbr></label>
          <input type="text" name="author" id="author" size="25" required aria-required='true'>
        </div>
        <div class="field" id="cmt-email">
          <label for="email">Your e-mail <abbr title="(required)">*</abbr></label>
          <input type="email" name="email" id="email" size="25" required aria-required='true'>
        </div>
        <div id="cmt-ackbar">
          <label for="age">Spam robots, please fill in this field. Humans should leave it blank.</label>
          <input type="text" name="age" id="age" size="4" tabindex="-1">
        </div>
            <div class="field" id="cmt-cmt">
        <label for="comment">Your comment</label> <textarea name="comment" id="comment" cols="50" rows="10" required="required" aria-required="true"></textarea>
      </div>
      <div class="field" id="comment-submit">
        <button name="submit" type="submit">Submit Comment</button>
      </div>
      <input type='hidden' name='comment_post_ID' value='47574' id='comment_post_ID' />
<input type='hidden' name='comment_parent' id='comment_parent' value='0' />
      <p style="display: none;"><input type="hidden" id="akismet_comment_nonce" name="akismet_comment_nonce" value="965b330b96" /></p><p style="display: none !important;"><label>&#916;<textarea name="ak_hp_textarea" cols="45" rows="8" maxlength="100"></textarea></label><input type="hidden" id="ak_js" name="ak_js" value="187"/><script>document.getElementById( "ak_js" ).setAttribute( "value", ( new Date() ).getTime() );</script></p></div>
    </form>
      </div></section><script>jQuery("#comment-form").submit(function() { return fc_checkform('req'); });</script>


</main><!-- /#content-main -->

  

    <footer class="footer section section--fullwidth">
      <div class="row">
        <p class="block block--1">
          Except where otherwise noted, content on this site is licensed
          under the
          <a href="https://creativecommons.org/licenses/by-sa/3.0/" rel="license external">Creative Commons Attribution Share-Alike License v3.0</a>
          or any later version.
        </p>
        <img class="footer__logo" alt="the Mozilla dino logo" src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-content/themes/Hax/img/dino.svg">
      </div>
    </footer>
  </div>
  <link rel='stylesheet' id='hljstheme-css'  href='https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-content/plugins/wp-code-highlightjs/styles/solarized-light.css?ver=0.6.2' type='text/css' media='all' />
<script type='text/javascript' src='https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-includes/js/comment-reply.min.js?ver=5.8.3' id='comment-reply-js'></script>
<script type='text/javascript' src='https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-includes/js/wp-embed.min.js?ver=5.8.3' id='wp-embed-js'></script>
<script type='text/javascript' src='https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-content/plugins/wp-code-highlightjs/highlight.common.pack.js?ver=0.6.2' id='hljs_preload-js'></script>
<script type='text/javascript' src='https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-content/plugins/wp-code-highlightjs/highlight.custom.pack.js?ver=0.6.2' id='hljs-js'></script>
    <style>pre.hljs {padding: 5px;}
pre.hljs code {}</style>
    <script type="text/javascript">
    (function($, window) {
        var init_fn_flag = false;
        var init_fn = (function() {
            if (init_fn_flag)
                return;
            init_fn_flag = true;
             hljs.configure({"tabReplace":"    "});
            $('pre code').each(function(i, block) {
                hljs.highlightBlock(block);
            });
        });
        $(document).ready(init_fn);
        $(window).on("load", init_fn);
    })(jQuery, window);
    </script>
  <script>
    // External links should open in a new tab.
    (function () {
      var postLinks = document.querySelectorAll('#content-main a');

      var origin = location.origin;

      for (var i = 0; i < postLinks.length; i++) {
        var link = postLinks[i];
        if (link.origin !== origin && !link.getAttribute('target')) {
          link.setAttribute('target', '_blank');
        }
      }
    })();

    window.addEventListener('load', function () {
      if (document.querySelector('#newsletterForm')) {
        var script = document.createElement('script');
        var path = document.head.getAttribute('data-template-path');
        script.setAttribute('src', path + '/js/newsletter.js');
        document.head.appendChild(script);
      }
    });
  </script>
</body>
</html>
