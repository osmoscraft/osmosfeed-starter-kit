

<!doctype html>
<html lang="en-US">
<head data-template-path="https://hacks.mozilla.org/wp-content/themes/Hax">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="google-site-verification" content="w2ocEMd5yV9IsGCjhq-7ls67r4VH-Ob6oWdiZpqjN8U">

  
  <meta name="title" content="Fuzzing rust-minidump for Embarrassment and Crashes &#8211; Part 2 – Mozilla Hacks - the Web developer blog">

    <meta property="og:site_name" content="Mozilla Hacks &#8211; the Web developer blog">
  <meta property="og:url" content="https://hacks.mozilla.org/2022/06/fuzzing-rust-minidump-for-embarrassment-and-crashes">
  <meta property="og:title" content="Fuzzing rust-minidump for Embarrassment and Crashes &#8211; Part 2 – Mozilla Hacks - the Web developer blog">
  <meta property="og:description" content="For the last year, we've been working on the development of rust-minidump. The final part in this series takes you through fuzzing rust-minidump.">
  <meta property="og:image" content="https://hacks.mozilla.org/files/2022/06/rust-minidump.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="600">

    <meta property="twitter:title" content="Fuzzing rust-minidump for Embarrassment and Crashes &#8211; Part 2 – Mozilla Hacks - the Web developer blog">
  <meta property="twitter:description" content="For the last year, we've been working on the development of rust-minidump. The final part in this series takes you through fuzzing rust-minidump.">
    <meta name="twitter:card" content="summary_large_image">
    <meta property="twitter:image" content="https://hacks.mozilla.org/files/2022/06/rust-minidump.png">
  <meta name="twitter:site" content="@mozhacks">

  <link href='//fonts.googleapis.com/css?family=Open+Sans:400,400italic,700,700italic' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-content/themes/Hax/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-content/themes/Hax/style.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/highlight.js/8.6.0/styles/solarized_light.min.css">

  <script type="text/javascript">
    window.hacks = {};
    // http://cfsimplicity.com/61/removing-analytics-clutter-from-campaign-urls
    var removeUtms  =   function(){
        var l = window.location;
        if( l.hash.indexOf( "utm" ) != -1 ){
            var anchor = l.hash.match(/#(?!utm)[^&]+/);
            anchor  =   anchor? anchor[0]: '';
            if(!anchor && window.history.replaceState){
                history.replaceState({},'', l.pathname + l.search);
            } else {
                l.hash = anchor;
            }
        };
    };

    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-35433268-8'],
              ['_setAllowAnchor', true]);
    _gaq.push (['_gat._anonymizeIp']);
    _gaq.push(['_trackPageview']);
    _gaq.push( removeUtms );
    (function(d, k) {
      var ga = d.createElement(k); ga.type = 'text/javascript'; ga.async = true;
      ga.src = 'https://ssl.google-analytics.com/ga.js';
      var s = d.getElementsByTagName(k)[0]; s.parentNode.insertBefore(ga, s);
    })(document, 'script');
  </script>

  <meta name='robots' content='index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1' />
<meta name="blog-name" content="Mozilla Hacks - the Web developer blog" />
<link rel="alternate" hreflang="en" href="https://hacks.mozilla.org/2022/06/fuzzing-rust-minidump-for-embarrassment-and-crashes/" />
<link rel="alternate" hreflang="x-default" href="https://hacks.mozilla.org/2022/06/fuzzing-rust-minidump-for-embarrassment-and-crashes/" />

	<!-- This site is optimized with the Yoast SEO plugin v18.8 - https://yoast.com/wordpress/plugins/seo/ -->
	<title>Fuzzing rust-minidump for Embarrassment and Crashes - Part 2 - Mozilla Hacks - the Web developer blog</title>
	<meta name="description" content="For the last year, we&#039;ve been working on the development of rust-minidump. The final part in this series takes you through fuzzing rust-minidump." />
	<link rel="canonical" href="https://hacks.mozilla.org/2022/06/fuzzing-rust-minidump-for-embarrassment-and-crashes/" />
	<meta name="twitter:label1" content="Written by" />
	<meta name="twitter:data1" content="Aria Beingessner" />
	<meta name="twitter:label2" content="Est. reading time" />
	<meta name="twitter:data2" content="16 minutes" />
	<script type="application/ld+json" class="yoast-schema-graph">{"@context":"https://schema.org","@graph":[{"@type":"WebSite","@id":"https://hacks.mozilla.org/#website","url":"https://hacks.mozilla.org/","name":"Mozilla Hacks - the Web developer blog","description":"hacks.mozilla.org","potentialAction":[{"@type":"SearchAction","target":{"@type":"EntryPoint","urlTemplate":"https://hacks.mozilla.org/?s={search_term_string}"},"query-input":"required name=search_term_string"}],"inLanguage":"en-US"},{"@type":"ImageObject","inLanguage":"en-US","@id":"https://hacks.mozilla.org/2022/06/fuzzing-rust-minidump-for-embarrassment-and-crashes/#primaryimage","url":"https://hacks.mozilla.org/files/2022/06/rust-minidump.png","contentUrl":"https://hacks.mozilla.org/files/2022/06/rust-minidump.png","width":1200,"height":600},{"@type":"WebPage","@id":"https://hacks.mozilla.org/2022/06/fuzzing-rust-minidump-for-embarrassment-and-crashes/#webpage","url":"https://hacks.mozilla.org/2022/06/fuzzing-rust-minidump-for-embarrassment-and-crashes/","name":"Fuzzing rust-minidump for Embarrassment and Crashes - Part 2 - Mozilla Hacks - the Web developer blog","isPartOf":{"@id":"https://hacks.mozilla.org/#website"},"primaryImageOfPage":{"@id":"https://hacks.mozilla.org/2022/06/fuzzing-rust-minidump-for-embarrassment-and-crashes/#primaryimage"},"datePublished":"2022-06-23T17:19:31+00:00","dateModified":"2022-06-23T18:25:06+00:00","author":{"@id":"https://hacks.mozilla.org/#/schema/person/c631cbbdfc4b26371a4944c96bdbf69b"},"description":"For the last year, we've been working on the development of rust-minidump. The final part in this series takes you through fuzzing rust-minidump.","breadcrumb":{"@id":"https://hacks.mozilla.org/2022/06/fuzzing-rust-minidump-for-embarrassment-and-crashes/#breadcrumb"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://hacks.mozilla.org/2022/06/fuzzing-rust-minidump-for-embarrassment-and-crashes/"]}]},{"@type":"BreadcrumbList","@id":"https://hacks.mozilla.org/2022/06/fuzzing-rust-minidump-for-embarrassment-and-crashes/#breadcrumb","itemListElement":[{"@type":"ListItem","position":1,"name":"Home","item":"https://hacks.mozilla.org/"},{"@type":"ListItem","position":2,"name":"Articles","item":"https://hacks.mozilla.org/articles/"},{"@type":"ListItem","position":3,"name":"Fuzzing rust-minidump for Embarrassment and Crashes &#8211; Part 2"}]},{"@type":"Person","@id":"https://hacks.mozilla.org/#/schema/person/c631cbbdfc4b26371a4944c96bdbf69b","name":"Aria Beingessner","image":{"@type":"ImageObject","inLanguage":"en-US","@id":"https://hacks.mozilla.org/#/schema/person/image/","url":"https://secure.gravatar.com/avatar/1039b5879e177382b62995025c567a59?s=96&d=mm&r=g","contentUrl":"https://secure.gravatar.com/avatar/1039b5879e177382b62995025c567a59?s=96&d=mm&r=g","caption":"Aria Beingessner"},"sameAs":["https://gankra.github.io/blah/"],"url":"https://hacks.mozilla.org/author/abeingessnermozilla-com/"}]}</script>
	<!-- / Yoast SEO plugin. -->


<link rel='dns-prefetch' href='//blog.mozilla.org' />
<link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="Mozilla Hacks - the Web developer blog &raquo; Feed" href="https://hacks.mozilla.org/feed/" />
<link rel="alternate" type="application/rss+xml" title="Mozilla Hacks - the Web developer blog &raquo; Comments Feed" href="https://hacks.mozilla.org/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="Mozilla Hacks - the Web developer blog &raquo; Fuzzing rust-minidump for Embarrassment and Crashes &#8211; Part 2 Comments Feed" href="https://hacks.mozilla.org/2022/06/fuzzing-rust-minidump-for-embarrassment-and-crashes/feed/" />
<link rel='stylesheet' id='wp-block-library-css'  href='https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-includes/css/dist/block-library/style.min.css?ver=5.9.3' type='text/css' media='all' />
<style id='global-styles-inline-css' type='text/css'>
body{--wp--preset--color--black: #000000;--wp--preset--color--cyan-bluish-gray: #abb8c3;--wp--preset--color--white: #ffffff;--wp--preset--color--pale-pink: #f78da7;--wp--preset--color--vivid-red: #cf2e2e;--wp--preset--color--luminous-vivid-orange: #ff6900;--wp--preset--color--luminous-vivid-amber: #fcb900;--wp--preset--color--light-green-cyan: #7bdcb5;--wp--preset--color--vivid-green-cyan: #00d084;--wp--preset--color--pale-cyan-blue: #8ed1fc;--wp--preset--color--vivid-cyan-blue: #0693e3;--wp--preset--color--vivid-purple: #9b51e0;--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple: linear-gradient(135deg,rgba(6,147,227,1) 0%,rgb(155,81,224) 100%);--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan: linear-gradient(135deg,rgb(122,220,180) 0%,rgb(0,208,130) 100%);--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange: linear-gradient(135deg,rgba(252,185,0,1) 0%,rgba(255,105,0,1) 100%);--wp--preset--gradient--luminous-vivid-orange-to-vivid-red: linear-gradient(135deg,rgba(255,105,0,1) 0%,rgb(207,46,46) 100%);--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray: linear-gradient(135deg,rgb(238,238,238) 0%,rgb(169,184,195) 100%);--wp--preset--gradient--cool-to-warm-spectrum: linear-gradient(135deg,rgb(74,234,220) 0%,rgb(151,120,209) 20%,rgb(207,42,186) 40%,rgb(238,44,130) 60%,rgb(251,105,98) 80%,rgb(254,248,76) 100%);--wp--preset--gradient--blush-light-purple: linear-gradient(135deg,rgb(255,206,236) 0%,rgb(152,150,240) 100%);--wp--preset--gradient--blush-bordeaux: linear-gradient(135deg,rgb(254,205,165) 0%,rgb(254,45,45) 50%,rgb(107,0,62) 100%);--wp--preset--gradient--luminous-dusk: linear-gradient(135deg,rgb(255,203,112) 0%,rgb(199,81,192) 50%,rgb(65,88,208) 100%);--wp--preset--gradient--pale-ocean: linear-gradient(135deg,rgb(255,245,203) 0%,rgb(182,227,212) 50%,rgb(51,167,181) 100%);--wp--preset--gradient--electric-grass: linear-gradient(135deg,rgb(202,248,128) 0%,rgb(113,206,126) 100%);--wp--preset--gradient--midnight: linear-gradient(135deg,rgb(2,3,129) 0%,rgb(40,116,252) 100%);--wp--preset--duotone--dark-grayscale: url('#wp-duotone-dark-grayscale');--wp--preset--duotone--grayscale: url('#wp-duotone-grayscale');--wp--preset--duotone--purple-yellow: url('#wp-duotone-purple-yellow');--wp--preset--duotone--blue-red: url('#wp-duotone-blue-red');--wp--preset--duotone--midnight: url('#wp-duotone-midnight');--wp--preset--duotone--magenta-yellow: url('#wp-duotone-magenta-yellow');--wp--preset--duotone--purple-green: url('#wp-duotone-purple-green');--wp--preset--duotone--blue-orange: url('#wp-duotone-blue-orange');--wp--preset--font-size--small: 13px;--wp--preset--font-size--medium: 20px;--wp--preset--font-size--large: 36px;--wp--preset--font-size--x-large: 42px;}.has-black-color{color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-color{color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-color{color: var(--wp--preset--color--white) !important;}.has-pale-pink-color{color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-color{color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-color{color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-color{color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-color{color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-color{color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-color{color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-color{color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-color{color: var(--wp--preset--color--vivid-purple) !important;}.has-black-background-color{background-color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-background-color{background-color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-background-color{background-color: var(--wp--preset--color--white) !important;}.has-pale-pink-background-color{background-color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-background-color{background-color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-background-color{background-color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-background-color{background-color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-background-color{background-color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-background-color{background-color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-background-color{background-color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-background-color{background-color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-background-color{background-color: var(--wp--preset--color--vivid-purple) !important;}.has-black-border-color{border-color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-border-color{border-color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-border-color{border-color: var(--wp--preset--color--white) !important;}.has-pale-pink-border-color{border-color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-border-color{border-color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-border-color{border-color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-border-color{border-color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-border-color{border-color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-border-color{border-color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-border-color{border-color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-border-color{border-color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-border-color{border-color: var(--wp--preset--color--vivid-purple) !important;}.has-vivid-cyan-blue-to-vivid-purple-gradient-background{background: var(--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple) !important;}.has-light-green-cyan-to-vivid-green-cyan-gradient-background{background: var(--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan) !important;}.has-luminous-vivid-amber-to-luminous-vivid-orange-gradient-background{background: var(--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange) !important;}.has-luminous-vivid-orange-to-vivid-red-gradient-background{background: var(--wp--preset--gradient--luminous-vivid-orange-to-vivid-red) !important;}.has-very-light-gray-to-cyan-bluish-gray-gradient-background{background: var(--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray) !important;}.has-cool-to-warm-spectrum-gradient-background{background: var(--wp--preset--gradient--cool-to-warm-spectrum) !important;}.has-blush-light-purple-gradient-background{background: var(--wp--preset--gradient--blush-light-purple) !important;}.has-blush-bordeaux-gradient-background{background: var(--wp--preset--gradient--blush-bordeaux) !important;}.has-luminous-dusk-gradient-background{background: var(--wp--preset--gradient--luminous-dusk) !important;}.has-pale-ocean-gradient-background{background: var(--wp--preset--gradient--pale-ocean) !important;}.has-electric-grass-gradient-background{background: var(--wp--preset--gradient--electric-grass) !important;}.has-midnight-gradient-background{background: var(--wp--preset--gradient--midnight) !important;}.has-small-font-size{font-size: var(--wp--preset--font-size--small) !important;}.has-medium-font-size{font-size: var(--wp--preset--font-size--medium) !important;}.has-large-font-size{font-size: var(--wp--preset--font-size--large) !important;}.has-x-large-font-size{font-size: var(--wp--preset--font-size--x-large) !important;}
</style>
<link rel='stylesheet' id='wpml-legacy-post-translations-0-css'  href='//blog.mozilla.org/hacks/wp-content/plugins/sitepress-multilingual-cms/templates/language-switchers/legacy-post-translations/style.min.css?ver=1' type='text/css' media='all' />
<script type='text/javascript' src='https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-includes/js/jquery/jquery.min.js?ver=3.6.0' id='jquery-core-js'></script>
<script type='text/javascript' src='https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-includes/js/jquery/jquery-migrate.min.js?ver=3.3.2' id='jquery-migrate-js'></script>
<script type='text/javascript' src='https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-content/themes/Hax/js/fc-checkcomment.js?ver=5.9.3' id='checkcomments-js'></script>
<script type='text/javascript' src='https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-content/themes/Hax/js/analytics.js?ver=5.9.3' id='analytics-js'></script>
<link rel="https://api.w.org/" href="https://hacks.mozilla.org/wp-json/" /><link rel="alternate" type="application/json" href="https://hacks.mozilla.org/wp-json/wp/v2/posts/47880" /><link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://hacks.mozilla.org/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://hacks.mozilla.org/wp-includes/wlwmanifest.xml" /> 
<link rel='shortlink' href='https://hacks.mozilla.org/?p=47880' />
<link rel="alternate" type="application/json+oembed" href="https://hacks.mozilla.org/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fhacks.mozilla.org%2F2022%2F06%2Ffuzzing-rust-minidump-for-embarrassment-and-crashes%2F" />
<link rel="alternate" type="text/xml+oembed" href="https://hacks.mozilla.org/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fhacks.mozilla.org%2F2022%2F06%2Ffuzzing-rust-minidump-for-embarrassment-and-crashes%2F&#038;format=xml" />
<meta name="generator" content="WPML ver:4.5.6 stt:59,61,1,2;" />
<link rel="shortcut icon" type="image/x-icon" href="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-content/themes/Hax/favicon.ico" /><style>#wpadminbar #wp-admin-bar-site-name>.ab-item:before { content: none !important;}li#wp-admin-bar-site-name a { background: url( "https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-content/themes/Hax/favicon.ico" ) left center/20px no-repeat !important; padding-left: 21px !important; background-size: 20px !important; } li#wp-admin-bar-site-name { margin-left: 5px !important; } li#wp-admin-bar-site-name {} #wp-admin-bar-site-name div a { background: none !important; }
</style></head>
<body>
  <div class="outer-wrapper">
    <header class="section section--fullwidth header">
      <div class="masthead row">
        <div class="branding block block--3">
          <h1>
            <a href="https://hacks.mozilla.org">
              <img class="branding__logo" src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-content/themes/Hax/img/mdn-logo-mono.svg">
              <img class="branding__wordmark" src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-content/themes/Hax/img/wordmark.svg" alt="Mozilla">
              <span class="branding__title">Hac<span class="logo-askew">k</span>s</span>
            </a>
          </h1>
        </div>
        <div class="search block block--2">
          <form class="search__form" method="get" action="https://hacks.mozilla.org/">
            <input type="search" name="s" class="search__input" placeholder="Search Mozilla Hacks" value="">
            <i class="fa fa-search search__badge"></i>
          </form>
        </div>
        <nav class="social">
          <a class="social__link youtube" href="http://www.youtube.com/user/mozhacks" title="YouTube"><i class="fa fa-youtube" aria-hidden="true"></i><span>Hacks on YouTube</span></a>
          <a class="social__link twitter" href="https://twitter.com/mozhacks" title="Twitter"><i class="fa fa-twitter" aria-hidden="true"></i><span>@mozhacks on Twitter</span></a>
          <a class="social__link rss" href="https://hacks.mozilla.org/feed/" title="RSS Feed"><i class="fa fa-rss" aria-hidden="true"></i><span>Hacks RSS Feed</span></a>
          <a class="fx-button" href="https://www.mozilla.org/firefox/download/thanks/?utm_source=hacks.mozilla.org&utm_medium=referral&utm_campaign=header-download-button&utm_content=header-download-button">Download Firefox</a>
        </nav>
      </div>
    </header>

  
<div id="content-head" class="section">
  <h1 class="post__title">Fuzzing rust-minidump for Embarrassment and Crashes &#8211; Part 2</h1>
  <div class="byline">
    <h3 class="post__author">
                      <img alt='' src='https://secure.gravatar.com/avatar/1039b5879e177382b62995025c567a59?s=64&#038;d=mm&#038;r=g' srcset='https://secure.gravatar.com/avatar/1039b5879e177382b62995025c567a59?s=128&#038;d=mm&#038;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' loading='lazy'/>        By
                                        <a class="url" href="https://gankra.github.io/blah/" rel="external me">Aria Beingessner</a>                            </h2>
    <div class="post__meta">
      Posted on
      <abbr class="published" title="2022-06-23T10:19:31-07:00">
        June 23, 2022      </abbr>
      <span class="entry-cat">in
        <a href="https://hacks.mozilla.org/category/featured/" rel="category tag" title="View all posts in Featured Article" >Featured Article</a>, <a href="https://hacks.mozilla.org/category/firefox/" rel="category tag" title="View all posts in Firefox" >Firefox</a>, <a href="https://hacks.mozilla.org/category/fuzzing/" rel="category tag" title="View all posts in fuzzing" >fuzzing</a>, <a href="https://hacks.mozilla.org/category/mozilla/" rel="category tag" title="View all posts in Mozilla" >Mozilla</a>,  and <a href="https://hacks.mozilla.org/category/rust-2/" rel="category tag" title="View all posts in Rust" >Rust</a>      </span>
            <div class="socialshare" data-type="bubbles"></div>
    </div>
  </div>
</div>

<main id="content-main" class="section article">
  <article class="post" role="article">
    <p><span style="font-weight: 400;">This is part 2 of a series of articles on rust-minidump. For part 1, see <a href="https://hacks.mozilla.org/2022/06/everything-is-broken-shipping-rust-minidump-at-mozilla/">here</a>.</span></p>
<p><span style="font-weight: 400;">So to recap, we rewrote breakpad&#8217;s minidump processor in Rust, wrote a ton of tests, and deployed to production without any issues. We killed it, perfect job.</span></p>
<p><span style="font-weight: 400;">And we </span><i><span style="font-weight: 400;">still</span></i><span style="font-weight: 400;"> got massively dunked on by the fuzzer. Just absolutely destroyed.</span></p>
<p><span style="font-weight: 400;">I was starting to pivot off of rust-minidump work because I needed a bit of palette cleanser before tackling round 2 (handling native debuginfo, filling in features for other groups who were interested in rust-minidump, adding extra analyses that we&#8217;d always wanted but were too much work to do in Breakpad, etc etc etc).</span></p>
<p><span style="font-weight: 400;">I was still getting some PRs from people filling in the corners they needed, but nothing that needed too much attention, a</span><span style="font-weight: 400;">nd then</span><a href="https://github.com/5225225"> <span style="font-weight: 400;">@5225225</span></a><span style="font-weight: 400;"> smashed through the windows and released a bunch of exploding fuzzy rabbits into my office. </span></p>
<p><span style="font-weight: 400;">I had no idea who they were or why they were there. When I asked they just lowered one of their seven pairs of sunglasses and said &#8220;Because I can. Now hold this bunny&#8221;. I did as I was told and held the bunny. It was a good bun. Dare I say, it was a true </span><i><span style="font-weight: 400;">bnnuy</span></i><span style="font-weight: 400;">: it was</span><a href="https://www.llvm.org/docs/LibFuzzer.html"> <span style="font-weight: 400;">libfuzzer</span></a><span style="font-weight: 400;">. (Huh? You thought it was gonna be</span><a href="https://github.com/google/AFL"> <span style="font-weight: 400;">AFL</span></a><span style="font-weight: 400;">? Weird.)</span></p>
<p><span style="font-weight: 400;">As it turns out, several folks had built out some </span><i><span style="font-weight: 400;">really nice</span></i><span style="font-weight: 400;"> infrastructure for quickly setting up a decent fuzzer for some Rust code:</span><a href="https://github.com/rust-fuzz/cargo-fuzz"> <span style="font-weight: 400;">cargo-fuzz</span></a><span style="font-weight: 400;">. They even wrote</span><a href="https://rust-fuzz.github.io/book/cargo-fuzz.html"> <span style="font-weight: 400;">a little book that walks you through the process</span></a><span style="font-weight: 400;">.</span></p>
<p><span style="font-weight: 400;">Apparently those folks had done such a good job that 5225225 had decided it would be a really great hobby to just pick up a random rust project and implement fuzzing for it. And then to fuzz it. And file issues. And PRs that fix those issues. And then implement even more fuzzing for it.</span></p>
<p><span style="font-weight: 400;">Please help my office is drowning in rabbits and I haven&#8217;t seen my wife in weeks.</span></p>
<p><span style="font-weight: 400;">As far as I can tell, the process seems to genuinely be pretty easy! I think their</span><a href="https://github.com/luser/rust-minidump/pull/405"> <span style="font-weight: 400;">first fuzzer for rust-minidump</span></a><span style="font-weight: 400;"> was basically just:</span></p>
<ul>
<li style="font-weight: 400;" aria-level="1"><span style="font-weight: 400;">checked out the project</span></li>
<li style="font-weight: 400;" aria-level="1"><span style="font-weight: 400;">run cargo fuzz init (which autogenerates a bunch of config files)</span></li>
<li style="font-weight: 400;" aria-level="1"><span style="font-weight: 400;">write a file with this:</span></li>
</ul>
<pre><span style="font-weight: 400;">#![no_main]</span>

<span style="font-weight: 400;">use libfuzzer_sys::fuzz_target;</span>
<span style="font-weight: 400;">use minidump::*;</span>

<span style="font-weight: 400;">fuzz_target!(|data: &amp;[u8]| {</span>
<span style="font-weight: 400;">    // Parse a minidump like a normal user of the library</span>
<span style="font-weight: 400;">    if let Ok(dump) = minidump::Minidump::read(data) {</span>
<span style="font-weight: 400;">        // Ask the library to get+parse several streams like a normal user.</span>

<span style="font-weight: 400;">        let _ = dump.get_stream::&lt;MinidumpAssertion&gt;();</span>
<span style="font-weight: 400;">        let _ = dump.get_stream::&lt;MinidumpBreakpadInfo&gt;();</span>
<span style="font-weight: 400;">        let _ = dump.get_stream::&lt;MinidumpCrashpadInfo&gt;();</span>
<span style="font-weight: 400;">        let _ = dump.get_stream::&lt;MinidumpException&gt;();</span>
<span style="font-weight: 400;">        let _ = dump.get_stream::&lt;MinidumpLinuxCpuInfo&gt;();</span>
<span style="font-weight: 400;">        let _ = dump.get_stream::&lt;MinidumpLinuxEnviron&gt;();</span>
<span style="font-weight: 400;">        let _ = dump.get_stream::&lt;MinidumpLinuxLsbRelease&gt;();</span>
<span style="font-weight: 400;">        let _ = dump.get_stream::&lt;MinidumpLinuxMaps&gt;();</span>
<span style="font-weight: 400;">        let _ = dump.get_stream::&lt;MinidumpLinuxProcStatus&gt;();</span>
<span style="font-weight: 400;">        let _ = dump.get_stream::&lt;MinidumpMacCrashInfo&gt;();</span>
<span style="font-weight: 400;">        let _ = dump.get_stream::&lt;MinidumpMemoryInfoList&gt;();</span>
<span style="font-weight: 400;">        let _ = dump.get_stream::&lt;MinidumpMemoryList&gt;();</span>
<span style="font-weight: 400;">        let _ = dump.get_stream::&lt;MinidumpMiscInfo&gt;();</span>
<span style="font-weight: 400;">        let _ = dump.get_stream::&lt;MinidumpModuleList&gt;();</span>
<span style="font-weight: 400;">        let _ = dump.get_stream::&lt;MinidumpSystemInfo&gt;();</span>
<span style="font-weight: 400;">        let _ = dump.get_stream::&lt;MinidumpThreadNames&gt;();</span>
<span style="font-weight: 400;">        let _ = dump.get_stream::&lt;MinidumpThreadList&gt;();</span>
<span style="font-weight: 400;">        let _ = dump.get_stream::&lt;MinidumpUnloadedModuleList&gt;();</span>
<span style="font-weight: 400;">    }</span>
<span style="font-weight: 400;">});</span></pre>
<p><span style="font-weight: 400;">And that&#8217;s&#8230; it? And all you have to do is type </span><span style="font-weight: 400;">cargo fuzz run</span><span style="font-weight: 400;"> and it downloads, builds, and spins up an instance of</span><a href="https://www.llvm.org/docs/LibFuzzer.html"> <span style="font-weight: 400;">libfuzzer</span></a><span style="font-weight: 400;"> and finds bugs in your project overnight?</span></p>
<p><span style="font-weight: 400;">Surely that won&#8217;t find anything interesting. Oh it did? It was largely all bugs in code I wrote? </span><b>Nice.</b></p>
<p><span style="font-weight: 400;">cargo fuzz is clearly awesome but let&#8217;s not downplay the amount of bafflingly incredible work that 5225225 did here! Fuzzers, sanitizers, and other code analysis tools have a </span><i><span style="font-weight: 400;">very bad</span></i><span style="font-weight: 400;"> reputation for drive-by contributions. </span></p>
<p><span style="font-weight: 400;">I think we&#8217;ve all heard stories of someone running a shiny new tool on some big project they know nothing about, mass filing a bunch of issues that just say &#8220;this tool says your code has a problem, fix it&#8221; and then disappearing into the mist and claiming victory.</span></p>
<p><span style="font-weight: 400;">This is not a pleasant experience for someone trying to maintain a project. You&#8217;re dumping a lot on my plate if I don&#8217;t know the tool, have trouble running the tool, don&#8217;t know exactly how you ran it, etc. </span></p>
<p><span style="font-weight: 400;">It&#8217;s also very easy to come up with a huge pile of issues with very little sense of how significant they are. </span></p>
<p><span style="font-weight: 400;">Some things are only vaguely dubious, while others are horribly terrifying exploits. We only have so much time to work on stuff, you&#8217;ve gotta help us out!</span></p>
<p><span style="font-weight: 400;">And in this regard 5225225&#8217;s contributions were just, bloody beautiful. </span></p>
<p><span style="font-weight: 400;">Like, shockingly fantastic.</span></p>
<p><span style="font-weight: 400;">They wrote really clear and detailed issues. When I skimmed those issues and misunderstood them, they quickly clarified and got me on the same page. And then they submitted a fix for the issue before I even considered working on the fix. And quickly responded to review comments. I didn&#8217;t even bother asking them to squashing their commits because damnit they </span><i><span style="font-weight: 400;">earned</span></i><span style="font-weight: 400;"> those 3 commits in the tree to fix one overflow.</span></p>
<p><span style="font-weight: 400;">Then they submitted a PR to merge the fuzzer. They helped me understand how to use it and debug issues. Then they started asking questions about the project and started writing more fuzzers for other parts of it. And now there&#8217;s like 5 fuzzers and a bunch of fixed issues!</span></p>
<p><span style="font-weight: 400;">I don&#8217;t care how good cargo fuzz is, that&#8217;s a lot of friggin&#8217; really good work! Like I am going to cry!! This was so helpful??? &#x1f62d;</span></p>
<p><span style="font-weight: 400;">That said, I will take a </span><i><span style="font-weight: 400;">little</span></i><span style="font-weight: 400;"> credit for this going so smoothly: both Rust itself and rust-minidump are written in a way that&#8217;s very friendly to fuzzing. Specifically, rust-minidump is riddled with assertions for &#8220;hmm this seems messed up and shouldn&#8217;t happen but maybe?&#8221; and Rust turns integer overflows into panics (crashes) in debug builds (and index-out-of-bounds is always a panic).</span></p>
<p><span style="font-weight: 400;">Having lots of assertions everywhere makes it </span><i><span style="font-weight: 400;">a lot</span></i><span style="font-weight: 400;"> easier to detect situations where things go wrong. And when you </span><i><span style="font-weight: 400;">do</span></i><span style="font-weight: 400;"> detect that situation, the crash will often point pretty close to where things went wrong.</span></p>
<p><span style="font-weight: 400;">As someone who has worked on detecting bugs in Firefox with sanitizer and fuzzing folks, let me tell you what really sucks to try to do anything with: &#8220;Hey so on my machine this enormous complicated machine-generated input caused Firefox to crash </span><i><span style="font-weight: 400;">somewhere</span></i><span style="font-weight: 400;"> this </span><i><span style="font-weight: 400;">one time</span></i><span style="font-weight: 400;">. No, I can&#8217;t reproduce it. You won&#8217;t be able to reproduce it either. Anyway, try to fix it?&#8221;</span></p>
<p><span style="font-weight: 400;">That&#8217;s not me throwing shade on anyone here. I am all of the people in that conversation. The struggle of productively fuzzing Firefox is all too real, and I do not have a good track record of fixing those kinds of bugs. </span></p>
<p><span style="font-weight: 400;">By comparison I am absolutely </span><i><span style="font-weight: 400;">thriving</span></i><span style="font-weight: 400;"> under &#8220;Yeah you can deterministically trip this assertion with this tiny input you can just check in as a unit test&#8221;.</span></p>
<p><span style="font-weight: 400;">And what did we screw up? Some legit stuff! It&#8217;s Rust code, so I am fairly confident none of the issues were </span><i><span style="font-weight: 400;">security</span></i><span style="font-weight: 400;"> concerns, but they were definitely quality of implementation issues, and could have been used to at very least denial-of-service the minidump processor.</span></p>
<p><span style="font-weight: 400;">Now let&#8217;s dig into the issues they found!</span></p>
<h2><b>#428: Corrupt stacks caused infinite loops until OOM on ARM64</b></h2>
<p><a href="https://github.com/luser/rust-minidump/issues/428"><span style="font-weight: 400;">Issue</span></a></p>
<p><span style="font-weight: 400;">As noted in the background, stackwalking is a giant heuristic mess and you can find yourself going backwards or stuck in an infinite loop. To keep this under control, stackwalkers generally require </span><i><span style="font-weight: 400;">forward progress</span></i><span style="font-weight: 400;">. </span></p>
<p><span style="font-weight: 400;">Specifically, they require the stack pointer to move down the stack. If the stack pointer ever goes backwards or stays the same, we just call it quits and end the stackwalk there.</span></p>
<p><span style="font-weight: 400;">However, you can&#8217;t be </span><i><span style="font-weight: 400;">so</span></i><span style="font-weight: 400;"> strict on ARM because leaf functions </span><i><span style="font-weight: 400;">may not change the stack size at all</span></i><span style="font-weight: 400;">. Normally this would be impossible because every function call </span><i><span style="font-weight: 400;">at least</span></i><span style="font-weight: 400;"> has to push the return address to the stack, but ARM has the </span><i><span style="font-weight: 400;">link register</span></i><span style="font-weight: 400;"> which is basically an extra buffer for the return address. </span></p>
<p><span style="font-weight: 400;">The existence of the link register in conjunction with an ABI that makes the callee responsible for saving and restoring it means leaf functions </span><i><span style="font-weight: 400;">can</span></i><span style="font-weight: 400;"> have 0-sized stack frames!</span></p>
<p><span style="font-weight: 400;">To handle this, an ARM stackwalker must allow for there to be no forward progress for the </span><i><span style="font-weight: 400;">first</span></i><span style="font-weight: 400;"> frame of a stackwalk, </span><b>and then become more strict</b><span style="font-weight: 400;">. Unfortunately I hand-waved that second part and ended up allowing infinite loops with no forward progress:</span></p>
<pre><span style="font-weight: 400;">// If the new stack pointer is at a lower address than the old,</span>
<span style="font-weight: 400;">// then that's clearly incorrect. Treat this as end-of-stack to</span>
<span style="font-weight: 400;">// enforce progress and avoid infinite loops.</span>
<span style="font-weight: 400;">//</span>
<span style="font-weight: 400;">// NOTE: this check allows for equality because arm leaf functions</span>
<span style="font-weight: 400;">// may not actually touch the stack (thanks to the link register</span>
<span style="font-weight: 400;">// allowing you to "push" the return address to a register).</span>
<span style="font-weight: 400;">if frame.context.get_stack_pointer() &lt; self.get_register_always("sp") as u64 {</span>
<span style="font-weight: 400;">    trace!("unwind: stack pointer went backwards, assuming unwind complete");</span>
<span style="font-weight: 400;">    return None;</span>
<span style="font-weight: 400;">}</span></pre>
<p><span style="font-weight: 400;">So if the ARM64 stackwalker ever gets stuck in an infinite loop on one frame, it will just build up an infinite backtrace until it&#8217;s killed by an OOM. This is very nasty because it&#8217;s a potentially very slow denial-of-service that eats up all the memory on the machine!</span></p>
<p><span style="font-weight: 400;">This issue was actually originally discovered and fixed in</span><a href="https://github.com/luser/rust-minidump/issues/300"> <span style="font-weight: 400;">#300</span></a> <i><span style="font-weight: 400;">without</span></i><span style="font-weight: 400;"> a fuzzer, but when I fixed it for ARM (32-bit) I completely forgot to do the same for ARM64. Thankfully the fuzzer was evil enough to discover this infinite looping situation on its own, and the fix was just &#8220;copy-paste the logic from the 32-bit impl&#8221;.</span></p>
<p><span style="font-weight: 400;">Because this issue was actually encountered in the wild, we know this was a serious concern! Good job, fuzzer!</span></p>
<p><span style="font-weight: 400;">(This issue specifically affected minidump-processor and minidump-stackwalk)</span></p>
<h3><b>#407: MinidumpLinuxMaps address-based queries didn&#8217;t work at all</b></h3>
<p><a href="https://github.com/luser/rust-minidump/issues/407"><span style="font-weight: 400;">Issue</span></a></p>
<p><span style="font-weight: 400;">MinidumpLinuxMaps is an interface for querying the dumped contents of Linux&#8217;s /proc/self/maps file. This provides metadata on the permissions and allocation state for mapped ranges of memory in the crashing process.</span></p>
<p><span style="font-weight: 400;">There are two usecases for this: just getting a full dump of all the process state, and specifically querying the memory properties for a specific address (&#8220;hey is this address executable?&#8221;). The dump usecase is handled by just shoving everything in a Vec. The address usecase requires us to create a RangeMap over the entries.</span></p>
<p><span style="font-weight: 400;">Unfortunately, a comparison was flipped in the code that created the keys to the RangeMap, which resulted in every </span><i><span style="font-weight: 400;">correct</span></i><span style="font-weight: 400;"> memory range being discarded AND invalid memory ranges being accepted. The fuzzer was able to catch this because the invalid ranges tripped an assertion when they got fed into the RangeMap (hurray for redundant checks!).</span></p>
<pre><span style="font-weight: 400;">// OOPS</span>
<span style="font-weight: 400;">if self.base_address &lt; self.final_address { </span>
<span style="font-weight: 400;"> return None; </span>
<span style="font-weight: 400;">}</span></pre>
<p><span style="font-weight: 400;">Although tests were written for MinidumpLinuxMaps, they didn&#8217;t include any invalid ranges, and just used the dump interface, so the fact that the RangeMap was empty went unnoticed!</span></p>
<p><span style="font-weight: 400;">This </span><i><span style="font-weight: 400;">probably</span></i><span style="font-weight: 400;"> would have been quickly found as soon as anyone tried to actually use this API in practice, but it&#8217;s nice that we caught it beforehand! Hooray for fuzzers!</span></p>
<p><span style="font-weight: 400;">(This issue specifically affected the minidump crate which technically could affect minidump-processor and minidump-stackwalk. Although they didn&#8217;t yet actually do address queries, they may have crashed when fed invalid ranges.)</span></p>
<h2><b>#381: OOM from reserving memory based on untrusted list length.</b></h2>
<p><a href="https://github.com/luser/rust-minidump/issues/381"><span style="font-weight: 400;">Issue</span></a></p>
<p><span style="font-weight: 400;">Minidumps have lots of lists which we end up collecting up in a Vec or some other collection. It&#8217;s quite natural and more efficient to start this process with something like </span><span style="font-weight: 400;">Vec::with_capacity(list_length)</span><span style="font-weight: 400;">. Usually this is fine, but if the minidump is corrupt (or malicious), then this length could be impossibly large and cause us to immediately OOM.</span></p>
<p><span style="font-weight: 400;">We were broadly aware that this was a problem, and had discussed the issue in</span><a href="https://github.com/luser/rust-minidump/issues/326"> <span style="font-weight: 400;">#326</span></a><span style="font-weight: 400;">, but then everyone left for the holidays. #381 was a nice kick in the pants to actually fix it, and gave us a free simple test case to check in.</span></p>
<p><span style="font-weight: 400;">Although the naive solution would be to fix this by just removing the reserves, we opted for a solution that guarded against obviously-incorrect array lengths. This allowed us to keep the performance win of reserving memory while also making rust-minidump fast-fail instead of vaguely trying to do something and hallucinating a mess.</span></p>
<p><span style="font-weight: 400;">Specifically, @Swatinem introduced a function for checking that the amount of memory left in the section we&#8217;re parsing is </span><i><span style="font-weight: 400;">large enough</span></i><span style="font-weight: 400;"> to even hold the claimed amount of items (based on their known serialized size). This should mean the minidump crate can only be induced to reserve O(n) memory, where n is the size of the minidump itself.</span></p>
<p><span style="font-weight: 400;">For some scale:</span></p>
<ul>
<li style="font-weight: 400;" aria-level="1"><span style="font-weight: 400;">A minidump for Firefox&#8217;s main process with about 100 threads is about 3MB.</span></li>
<li style="font-weight: 400;" aria-level="1"><span style="font-weight: 400;">A minidump for a stackoverflow from infinite recursion (8MB stack, 9000 calls) is about 8MB.</span></li>
<li style="font-weight: 400;" aria-level="1"><span style="font-weight: 400;">A breakpad symbol file for Firefox&#8217;s main module can be about </span><b>200MB</b><span style="font-weight: 400;">.</span></li>
</ul>
<p><span style="font-weight: 400;">If you&#8217;re symbolicating, Minidumps probably won&#8217;t be your memory bottleneck. &#x1f639;</span></p>
<p><span style="font-weight: 400;">(This issue specifically affected the minidump crate and therefore also minidump-processor and minidump-stackwalk.)</span></p>
<h2><b>The Many Integer Overflows and My Greatest Defeat</b></h2>
<p><span style="font-weight: 400;">The rest of the issues found were relatively benign integer overflows. I claim they&#8217;re benign because rust-minidump should </span><i><span style="font-weight: 400;">already</span></i><span style="font-weight: 400;"> be working under the assumption that all the values it reads out of the minidump could be corrupt garbage. This means its code is riddled with &#8220;is this nonsense&#8221; checks and those usually very quickly catch an overflow (or at worst print a nonsense value for some pointer).</span></p>
<p><span style="font-weight: 400;">We still fixed them all, because that&#8217;s shaky as heck logic and we want to be robust. But yeah none of these were even denial-of-service issues, as far as I know.</span></p>
<p><span style="font-weight: 400;">To demonstrate this, let&#8217;s discuss the most evil and embarrassing overflow which was definitely my fault and I am </span><i><span style="font-weight: 400;">still</span></i><span style="font-weight: 400;"> mad about it but in a like &#8220;how the heck&#8221; kind of way!?</span></p>
<p><span style="font-weight: 400;">The overflow is back in our old friend the stackwalker. Specifically in the code that attempts to unwind using frame pointers. Even more specifically, when offsetting the supposed frame-pointer to get the location of the supposed return address:</span></p>
<pre><span style="font-weight: 400;">let caller_ip = stack_memory.get_memory_at_address(last_bp + POINTER_WIDTH)?;</span>
<span style="font-weight: 400;">let caller_bp = stack_memory.get_memory_at_address(last_bp)?;</span>
<span style="font-weight: 400;">let caller_sp = last_bp + POINTER_WIDTH * 2;</span></pre>
<p><span style="font-weight: 400;">If the frame pointer (</span><span style="font-weight: 400;">last_bp</span><span style="font-weight: 400;">) was ~</span><span style="font-weight: 400;">u64::MAX</span><span style="font-weight: 400;">, the offset on the first line would overflow and we would instead try to load ~null. All of our loads are explicitly fallible (we assume everything is corrupt garbage!), and nothing is ever mapped to the null page in normal applications, so this load would reliably fail as if we had guarded the overflow. Hooray!</span></p>
<p><span style="font-weight: 400;">&#8230;but the overflow would panic in debug builds because that&#8217;s how debug builds work in Rust!</span></p>
<p><span style="font-weight: 400;">This was actually found, reported, and fixed </span><i><span style="font-weight: 400;">without</span></i><span style="font-weight: 400;"> a fuzzer in</span><a href="https://github.com/luser/rust-minidump/issues/251"> <span style="font-weight: 400;">#251</span></a><span style="font-weight: 400;">. All it took was a simple guard:</span></p>
<p><span style="font-weight: 400;">(All the casts are because this specific code is used in the x86 impl </span><i><span style="font-weight: 400;">and</span></i><span style="font-weight: 400;"> the x64 impl.)</span></p>
<pre><span style="font-weight: 400;">if last_bp as u64 &gt;= u64::MAX - POINTER_WIDTH as u64 * 2 {</span>
<span style="font-weight: 400;">    // Although this code generally works fine if the pointer math overflows,</span>
<span style="font-weight: 400;">    // debug builds will still panic, and this guard protects against it without</span>
<span style="font-weight: 400;">    // drowning the rest of the code in checked_add.</span>
<span style="font-weight: 400;">    return None;</span>
<span style="font-weight: 400;">}</span>

<span style="font-weight: 400;">let caller_ip = stack_memory.get_memory_at_address(last_bp as u64 + POINTER_WIDTH as u64)?;</span>
<span style="font-weight: 400;">let caller_bp = stack_memory.get_memory_at_address(last_bp as u64)?;</span>
<span style="font-weight: 400;">let caller_sp = last_bp + POINTER_WIDTH * 2;</span></pre>
<p><span style="font-weight: 400;">And then it was found, reported, and fixed </span><b>again</b> <i><span style="font-weight: 400;">with a fuzzer</span></i><span style="font-weight: 400;"> in</span><a href="https://github.com/luser/rust-minidump/issues/422"> <span style="font-weight: 400;">#422</span></a><span style="font-weight: 400;">.</span></p>
<p><span style="font-weight: 400;">Wait what?</span></p>
<p><span style="font-weight: 400;">Unlike the infinite loop bug, I </span><i><span style="font-weight: 400;">did</span></i><span style="font-weight: 400;"> remember to add guards to all the unwinders for this problem&#8230; but I did the overflow check in 64-bit </span><i><span style="font-weight: 400;">even for the 32-bit platforms</span></i><span style="font-weight: 400;">.</span></p>
<p><b>slaps forehead</b></p>
<p><span style="font-weight: 400;">This made the bug report especially confusing at first because the overflow was like 3 lines away from </span><i><span style="font-weight: 400;">a guard for that exact overflow</span></i><span style="font-weight: 400;">. As it turns out, the mistake wasn&#8217;t actually as obvious as it sounds! To understand what went wrong, let&#8217;s talk a bit more about pointer width in minidumps.</span></p>
<p><span style="font-weight: 400;">A single instance of rust-minidump has to be able to handle crash reports from </span><i><span style="font-weight: 400;">any</span></i><span style="font-weight: 400;"> platform, even ones it isn&#8217;t natively running on. This means it needs to be able to handle both 32-bit and 64-bit platforms in one binary. To avoid the misery of copy-pasting everything or making everything generic over pointer size, rust-minidump prefers to work with 64-bit values wherever possible, even for 32-bit plaftorms.</span></p>
<p><span style="font-weight: 400;">This isn&#8217;t just us being lazy: the minidump format itself does this! Regardless of the platform, a minidump will refer to ranges of memory with a</span><a href="https://docs.microsoft.com/en-us/windows/win32/api/minidumpapiset/ns-minidumpapiset-minidump_memory_descriptor"> <span style="font-weight: 400;">MINIDUMP_MEMORY_DESCRIPTOR</span></a><span style="font-weight: 400;"> whose base address is a 64-bit value, even on 32-bit platforms!</span></p>
<pre><span style="font-weight: 400;">typedef struct _MINIDUMP_MEMORY_DESCRIPTOR {</span>
<span style="font-weight: 400;">  ULONG64                      StartOfMemoryRange;</span>
<span style="font-weight: 400;">  MINIDUMP_LOCATION_DESCRIPTOR Memory;</span>
<span style="font-weight: 400;">} MINIDUMP_MEMORY_DESCRIPTOR, *PMINIDUMP_MEMORY_DESCRIPTOR;</span></pre>
<p><span style="font-weight: 400;">So quite naturally rust-minidump&#8217;s interface for querying saved regions of memory just operates on 64-bit (u64) addresses unconditionally, and 32-bit-specific code casts its u32 address to a u64 before querying memory.</span></p>
<p><span style="font-weight: 400;">That means the code with the overflow guard </span><i><span style="font-weight: 400;">was</span></i><span style="font-weight: 400;"> manipulating those values as u64s on x86! The </span><i><span style="font-weight: 400;">problem</span></i><span style="font-weight: 400;"> is that after all the memory loads we would then go back to &#8220;native&#8221; sizes and compute </span><span style="font-weight: 400;">caller_sp = last_bp + POINTER_WIDTH * 2</span><span style="font-weight: 400;">. This would overflow a u32 and crash in debug builds. &#x1f63f;</span></p>
<p><span style="font-weight: 400;">But here&#8217;s the really messed up part: </span><i><span style="font-weight: 400;">getting to that point meant we were successfully loading memory up to that address</span></i><span style="font-weight: 400;">. The first line where we compute caller_ip reads it! So this overflow means&#8230; we were&#8230; loading memory&#8230; from an address that was beyond u32::MAX&#8230;!?</span></p>
<p><span style="font-weight: 400;">Yes!!!!!!!!</span></p>
<p><span style="font-weight: 400;">The fuzzer had found an absolutely </span><i><span style="font-weight: 400;">brilliantly evil input</span></i><span style="font-weight: 400;">.</span></p>
<p><span style="font-weight: 400;">It abused the fact that MINIDUMP_MEMORY_DESCRIPTOR </span><i><span style="font-weight: 400;">technically</span></i><span style="font-weight: 400;"> lets 32-bit minidumps define memory ranges beyond </span><span style="font-weight: 400;">u32::MAX</span> <i><span style="font-weight: 400;">even though they could never actually access that memory!</span></i><span style="font-weight: 400;"> It could then have the u64-based memory accesses succeed but still have the &#8220;native&#8221; 32-bit operation overflow!</span></p>
<p><span style="font-weight: 400;">This is so messed up that I didn&#8217;t even </span><i><span style="font-weight: 400;">comprehend</span></i><span style="font-weight: 400;"> that it had done this until I wrote my own test and realized that it wasn&#8217;t actually failing because I </span><i><span style="font-weight: 400;">foolishly</span></i><span style="font-weight: 400;"> had limited the range of valid memory to the mere 4GB a normal x86 process is restricted to.</span></p>
<p><span style="font-weight: 400;">And I mean that quite literally: this is exactly the issue that creates</span><a href="https://youtu.be/kpk2tdsPh0A?t=638"> <span style="font-weight: 400;">Parallel Universes in Super Mario 64</span></a><span style="font-weight: 400;">.</span></p>
<p><span style="font-weight: 400;">But hey my code was probably just bad. I know google loves sanitizers and fuzzers, so I bet google breakpad found this overflow ages ago and fixed it:</span></p>
<pre><span style="font-weight: 400;">uint32_t last_esp = last_frame-&gt;context.esp;</span>
<span style="font-weight: 400;">uint32_t last_ebp = last_frame-&gt;context.ebp;</span>
<span style="font-weight: 400;">uint32_t caller_eip, caller_esp, caller_ebp;</span>

<span style="font-weight: 400;">if (memory_-&gt;GetMemoryAtAddress(last_ebp + 4, &amp;caller_eip) &amp;&amp;</span>
<span style="font-weight: 400;">    memory_-&gt;GetMemoryAtAddress(last_ebp, &amp;caller_ebp)) {</span>
<span style="font-weight: 400;">    caller_esp = last_ebp + 8;</span>
<span style="font-weight: 400;">    trust = StackFrame::FRAME_TRUST_FP;</span>
<span style="font-weight: 400;">} else {</span>
<span style="font-weight: 400;">    ...</span></pre>
<p><span style="font-weight: 400;">Ah. Hmm. They don&#8217;t guard for any kind of overflow for those uint32_t&#8217;s (or the uint64_t&#8217;s in the x64 impl).</span></p>
<p><span style="font-weight: 400;">Well ok GetMemoryAtAddress does actual bounds checks so the load from ~null will generally fail like it does in rust-minidump. But what about the Parallel Universe overflow that lets GetMemoryAtAddress succeed?</span></p>
<p><span style="font-weight: 400;">Ah well surely breakpad is more principled with integer width than I was&#8211;</span></p>
<pre><span style="font-weight: 400;">virtual bool GetMemoryAtAddress(uint64_t address, uint8_t*  value) const = 0;</span>
<span style="font-weight: 400;">virtual bool GetMemoryAtAddress(uint64_t address, uint16_t* value) const = 0;</span>
<span style="font-weight: 400;">virtual bool GetMemoryAtAddress(uint64_t address, uint32_t* value) const = 0;</span>
<span style="font-weight: 400;">virtual bool GetMemoryAtAddress(uint64_t address, uint64_t* value) const = 0;</span>
</pre>
<p><span style="font-weight: 400;">Whelp congrats to 5225225 for finding an overflow that&#8217;s portable between two implementations in two completely different languages by exploiting the very nature of the file format itself!</span></p>
<p><span style="font-weight: 400;">In case you&#8217;re wondering what the implications of this overflow are: it&#8217;s still basically benign. Both rust-minidump and google-breakpad will successfully complete the frame pointer analysis and yield a frame with a ~null stack pointer.</span></p>
<p><span style="font-weight: 400;">Then the outer layer of the stackwalker which runs all the different passes in sequence will see something succeeded but that the frame pointer went backwards. At this point it will discard the stack frame and terminate the stackwalk normally and just calmly output whatever the backtrace was up to that point. Totally normal and reasonable operation.</span></p>
<p><span style="font-weight: 400;">I expect this is why no one would notice this in breakpad even if you run fuzzers and sanitizers on it: nothing in the code actually does anything </span><i><span style="font-weight: 400;">wrong</span></i><span style="font-weight: 400;">. Unsigned integers are defined to wrap, the program behaves reasonably, everything is </span><i><span style="font-weight: 400;">kinda</span></i><span style="font-weight: 400;"> fine. We only noticed this in rust-minidump because </span><i><span style="font-weight: 400;">all</span></i><span style="font-weight: 400;"> integer overflows panic in Rust debug builds.</span></p>
<p><span style="font-weight: 400;">However this &#8220;benign&#8221; behaviour </span><i><span style="font-weight: 400;">is</span></i><span style="font-weight: 400;"> slightly different from properly guarding the overflow. Both implementations will normally try to move on to </span><i><span style="font-weight: 400;">stack scanning</span></i><span style="font-weight: 400;"> when the frame pointer analysis fails, but in this case they give up immediately. It&#8217;s </span><i><span style="font-weight: 400;">important</span></i><span style="font-weight: 400;"> that the frame pointer analysis properly identifies failures so that this cascading can occur. Failing to do so is definitely a bug!</span></p>
<p><span style="font-weight: 400;">However in this case the stack is partially in a parallel universe, so getting any kind of useful backtrace out of it is&#8230; dubious to say the least.</span></p>
<p><span style="font-weight: 400;">So I totally stand by &#8220;this is totally benign and not actually a problem&#8221; but also &#8220;this is sketchy and we should have the bounds check so we can be confident in this code&#8217;s robustness and correctness&#8221;.</span></p>
<p><span style="font-weight: 400;">Minidumps are </span><i><span style="font-weight: 400;">all</span></i><span style="font-weight: 400;"> corner cases &#8212; they literally get generated </span><i><span style="font-weight: 400;">when a program encounters an unexpected corner case</span></i><span style="font-weight: 400;">! It&#8217;s </span><i><span style="font-weight: 400;">so</span></i><span style="font-weight: 400;"> tempting to constantly shrug off situations as &#8220;well no reasonable program would ever do this, so we can ignore it&#8221;&#8230; but YOU CAN&#8217;T.</span></p>
<p><span style="font-weight: 400;">You would not have a minidump at your doorstep if the program had behaved reasonably! The fact that you are trying to inspect a minidump means something messed up happened, and you need to just deal with it!</span></p>
<p><span style="font-weight: 400;">That&#8217;s why we put so much energy into testing this thing, it&#8217;s a nightmare!</span></p>
<p><span style="font-weight: 400;">I am </span><i><span style="font-weight: 400;">extremely</span></i><span style="font-weight: 400;"> paranoid about this stuff, but that paranoia is based on the horrors I have seen. There are always more corner cases. </span></p>
<p><span style="font-weight: 400;">There are </span><i><span style="font-weight: 400;">ALWAYS</span></i><span style="font-weight: 400;"> more corner cases. </span><b>ALWAYS</b><span style="font-weight: 400;">.</span></p>
<p>&nbsp;</p>
    <section class="about">
                                <h2 class="about__header">About
                          <a class="url" href="https://gankra.github.io/blah/" rel="external me">
                Aria Beingessner              </a>
                      </h3>
                    <ul class="author-meta fa-ul"><li><i class="fa-li fa fa-globe"></i><a href="https://gankra.github.io/blah/" class="website" rel="me">https://gankra.github.io/blah/</a></li></ul>            <p><a class="url" href="https://hacks.mozilla.org/author/abeingessnermozilla-com/">More articles by Aria Beingessner&hellip;</a></p>
                  </section>
  </article>
  <section class="promo">
    <form id="newsletterForm" name="newsletter-form" class="newsletter block block--1 block--polite" action="https://www.mozilla.org/en-US/newsletter/" method="post">
  <h2 class="heading">Discover great resources for web development</h2>
  <p class="newsletter__description">Sign up for the Mozilla Developer Newsletter:</p>
  <input id="fmt" name="fmt" value="H" type="hidden">
  <input id="newsletterNewslettersInput" name="newsletters" value="app-dev" type="hidden">

  <div id="newsletterErrors" class="newsletter__errors"></div>

  <div id="newsletterEmail" class="form__row">
    <label for="newsletterEmailInput" class="offscreen">E-mail</label>
    <input id="newsletterEmailInput" name="email" class="newsletter__input" required="" placeholder="you@example.com" size="30" type="email">
  </div>

  <div id="newsletterPrivacy" class="form__row form__fineprint">
    <input id="newsletterPrivacyInput" name="privacy" required="" type="checkbox">
    <label for="newsletterPrivacyInput">
      I'm okay with Mozilla handling my info as explained in this <a href="https://www.mozilla.org/privacy/">Privacy Policy</a>.
    </label>
  </div>
  <button id="newsletter-submit" type="submit" class="button positive">Sign up now</button>
</form>
<div id="newsletterThanks" class="newsletter newsletter--thanks block block--1 block--polite hidden">
  <h2 class="heading">Thanks! Please check your inbox to confirm your subscription.</h2>
  <p>If you haven’t previously confirmed a subscription to a Mozilla-related newsletter you may have to do so. Please check your inbox or your spam filter for an email from us.
  </p>
</div>
  </section>
  

<section class="discussion">
  <hr class="dino">
  <div class="comments">
    <header class="comments__head">
      <h3>No comments yet</h3>
    </header>

      </div>
  <div class="response" id="respond">
        <form id="comment-form" action="https://hacks.mozilla.org/wp-comments-post.php" method="post">
        <h3>Post Your Comment</h3>
        <p id="cancel-comment-reply"><a rel="nofollow" id="cancel-comment-reply-link" href="/2022/06/fuzzing-rust-minidump-for-embarrassment-and-crashes/#respond" style="display:none;">Cancel Reply</a></p>
              <div class="field" id="cmt-name">
          <label for="author">Your name <abbr title="(required)">*</abbr></label>
          <input type="text" name="author" id="author" size="25" required aria-required='true'>
        </div>
        <div class="field" id="cmt-email">
          <label for="email">Your e-mail <abbr title="(required)">*</abbr></label>
          <input type="email" name="email" id="email" size="25" required aria-required='true'>
        </div>
        <div id="cmt-ackbar">
          <label for="age">Spam robots, please fill in this field. Humans should leave it blank.</label>
          <input type="text" name="age" id="age" size="4" tabindex="-1">
        </div>
            <div class="field" id="cmt-cmt">
        <label for="comment">Your comment</label> <textarea name="comment" id="comment" cols="50" rows="10" required="required" aria-required="true"></textarea>
      </div>
      <div class="field" id="comment-submit">
        <button name="submit" type="submit">Submit Comment</button>
      </div>
      <input type='hidden' name='comment_post_ID' value='47880' id='comment_post_ID' />
<input type='hidden' name='comment_parent' id='comment_parent' value='0' />
      <p style="display: none;"><input type="hidden" id="akismet_comment_nonce" name="akismet_comment_nonce" value="7852ebeb9c" /></p><p style="display: none !important;"><label>&#916;<textarea name="ak_hp_textarea" cols="45" rows="8" maxlength="100"></textarea></label><input type="hidden" id="ak_js_1" name="ak_js" value="242"/><script>document.getElementById( "ak_js_1" ).setAttribute( "value", ( new Date() ).getTime() );</script></p></div>
    </form>
      </div></section><script>jQuery("#comment-form").submit(function() { return fc_checkform('req'); });</script>


</main><!-- /#content-main -->

  

    <footer class="footer section section--fullwidth">
      <div class="row">
        <p class="block block--1">
          Except where otherwise noted, content on this site is licensed
          under the
          <a href="https://creativecommons.org/licenses/by-sa/3.0/" rel="license external">Creative Commons Attribution Share-Alike License v3.0</a>
          or any later version.
        </p>
        <img class="footer__logo" alt="the Mozilla dino logo" src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-content/themes/Hax/img/dino.svg">
      </div>
    </footer>
  </div>
  <link rel='stylesheet' id='hljstheme-css'  href='https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-content/plugins/wp-code-highlightjs/styles/solarized-light.css?ver=0.6.2' type='text/css' media='all' />
<script type='text/javascript' src='https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-includes/js/comment-reply.min.js?ver=5.9.3' id='comment-reply-js'></script>
<script type='text/javascript' src='https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-content/plugins/wp-code-highlightjs/highlight.common.pack.js?ver=0.6.2' id='hljs_preload-js'></script>
<script type='text/javascript' src='https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/wp-content/plugins/wp-code-highlightjs/highlight.custom.pack.js?ver=0.6.2' id='hljs-js'></script>
    <style>pre.hljs {padding: 5px;}
pre.hljs code {}</style>
    <script type="text/javascript">
    (function($, window) {
        var init_fn_flag = false;
        var init_fn = (function() {
            if (init_fn_flag)
                return;
            init_fn_flag = true;
             hljs.configure({"tabReplace":"    "});
            $('pre code').each(function(i, block) {
                hljs.highlightBlock(block);
            });
        });
        $(document).ready(init_fn);
        $(window).on("load", init_fn);
    })(jQuery, window);
    </script>
  <script>
    // External links should open in a new tab.
    (function () {
      var postLinks = document.querySelectorAll('#content-main a');

      var origin = location.origin;

      for (var i = 0; i < postLinks.length; i++) {
        var link = postLinks[i];
        if (link.origin !== origin && !link.getAttribute('target')) {
          link.setAttribute('target', '_blank');
        }
      }
    })();

    window.addEventListener('load', function () {
      if (document.querySelector('#newsletterForm')) {
        var script = document.createElement('script');
        var path = document.head.getAttribute('data-template-path');
        script.setAttribute('src', path + '/js/newsletter.js');
        document.head.appendChild(script);
      }
    });
  </script>
</body>
</html>
